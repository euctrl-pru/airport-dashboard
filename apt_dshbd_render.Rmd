---
params:
   icao:         $icao
   iata:         $iata
   name:         $name
   state:        $state
   apdf:         $apdf   
   punc:         $punc   
   config:       $config
   ldgsum:       $ldgsum
   latest:       $latest
   tfcvar:       $tfcvar
   tfc:          $tfc
   market:       $market
   thru:         $thru
   atfm:         $atfm   
   slot_yy:      $slot_yy
   slot_mm:      $slot_mm      
   punc_dep_yy:  $punc_dep_yy
   punc_dep_mm:  $punc_dep_mm
   punc_arr_yy:  $punc_arr_yy
   punc_arr_mm:  $punc_arr_mm
   asma_yy:      $asma_yy
   asma_mm:      $asma_mm
   txot_yy:      $txot_yy
   txot_mm:      $txot_mm
   txin_yy:      $txin_yy
   txin_mm:      $txin_mm
   pddly_yy:     $pddly_yy
   pddly_mm:     $pddly_mm  
   pddly_yy_avg: $pddly_yy_avg
   pddly_mm_avg: $pddly_avg
   dly_yy:       $dly_yy
   dly_mm:       $dly_mm
   turn_yy:      $turn_yy
   turn_mm:      $turn_mm
   turn_new:     $turn_new
   cdo_cco:      $cdo_cco

title         : "`r params$icao`"
author        : "AIU Home"

output: 
  flexdashboard ::flex_dashboard:
    orientation : rows
    logo        : '/images/euctrl-logo-noname_48x48.png'
    favicon     : 'favicon.png'
    lib_dir     : 'docs/libs'
    self_contained: FALSE
---

<script>
$('.navbar-logo').wrap('<a href="https://www.eurocontrol.int">');
$('.navbar-author').wrap('<a href="https://ansperformance.eu">');
</script>

<style>
.navbar-author {color: white;}
</style>

```{r setup, include=FALSE}
library(flexdashboard)
library(DT)
library(ggplot2)
library(dplyr)
library(tidyr)
library(plotly)
library(magick)
library(here)
library(stringr)
library(treemapify)
```

```{r plotly-utility}
tick_yr <- list(
  dtick = 1,
  ticktext = list(
    "Jan", "Feb", "Mar", "Apr", "May", "Jun",
    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
  ),
  tickvals = list(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12),
  tickmode = "array",
  range = c(0.5, 12.5)
)

tick_yr_no_title <- list(
  title = "",
  dtick = 1,
  ticktext = list(
    "Jan", "Feb", "Mar", "Apr", "May", "Jun",
    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
  ),
  tickvals = list(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12),
  tickmode = "array",
  range = c(0.5, 12.5)
)

pick_mth <- c(
  "Jan", "Feb", "Mar", "Apr", "May", "Jun",
  "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
)

config_bar_remove_buttons <- c(
  "sendDataToCloud",
  "autoScale2d",
  "select2d",
  "lasso2d",
  "pan2d",
  "zoom2d",
  "zoomIn2d",
  "zoomOut2d",
  "zoomInGeo",
  "zoomOutGeo",
  "hoverClosestCartesian",
  "hoverCompareCartesian",
  "toggleSpikelines",
  "drawrect"
)
```

# Overview {data-icon="fa-home"}

## Row ----------------------------------------------------------
### Aerodrome Layout

```{r airport-layout}
apt_layout_file <- here("layouts", paste0(params$icao, ".png"))
if (fs::file_exists(apt_layout_file)) {
  fs::file_copy(apt_layout_file,
    paste0("docs/", params$icao, ".png"),
    overwrite = TRUE
  )
  knitr::include_graphics(paste0("docs/", params$icao, ".png"))
}
```


### General

```{r apt-id}
ID_TBL <- tribble(
  ~ITEM, ~TEXT1, ~TEXT2,
  "Airport", params$name, "",
  "ICAO/IATA", paste0(params$icao, "/", params$iata), "",
  "State", params$state, "",
  "", "", ""
)

RWY_CONFIG <- params$config %>%
  mutate(ITEM = "") %>%
  select(
    ITEM,
    TEXT1 = CONFIGURATION,
    TEXT2 = SHARE_PCT
  ) %>%
  mutate(TEXT2 = paste0(round(100 * TEXT2), "%")) %>%
  na.omit()

RWY_CONFIG$ITEM[1] <- "Configurations in 2019"

ID_TBL <- ID_TBL %>%
  bind_rows(RWY_CONFIG)

ID_TBL %>%
  datatable(
    options = list(
      dom        = "t",
      ordering   = FALSE,
      autoWidth  = TRUE,
      columnDefs = list(list(width = "150px", targets = c(0))),
      scrollX    = TRUE
    ),
    colnames  = rep("", ncol(ID_TBL)),
    rownames  = FALSE,
    selection = "none",
    caption   = htmltools::tags$caption(
      style   = "caption-side: bottom; text-align: right;",
      "Only configurations with a minimum of 3% share are shown. Source: AIU Analysis"
    )
  ) %>%
  formatStyle(names(ID_TBL), lineHeight = "70%")
```

## Row ----------------------------------------------------------
### Summary

```{r front-page-table}
if (params$apdf == "Y") {
  source(here("R", "apt_dshbd_frontpage.R"))

  out <- prepare_front_page_DT(
    params$icao,
    params$tfc,
    params$asma_mm,
    params$txot_mm,
    params$atfm,
    params$ldgsum,
    params$latest
  )

  out %>%
    datatable(
      options = list(
        dom = "t",
        pageLength = nrow(out),
        ordering = FALSE,
        columnDefs = list(list(
          className = "dt-center",
          targets = "_all"
        )),
        fnDrawCallback = htmlwidgets::JS("function(){HTMLWidgets.staticRender();}")
      ),
      escape = FALSE,
      colnames = c(
        "Indicator",
        "Year 2019",
        "Most Recent Month",
        "12-month Trend"
      ),
      rownames = FALSE,
      caption = htmltools::tags$caption(
        style = "caption-side: bottom; text-align: right;",
        "Performance measures (other than traffic) are typically reported for the month preceeding the previous month, i.e. July -> May. Data reported under Most Recent Month dating back further point at on-going quality validation or missing reporting."
      )
    ) %>%
    spk_add_deps()
} else {
  source(here("R", "apt_dshbd_frontpage.R"))

  out <- prepare_front_page_NON_APDF(
    params$icao,
    params$tfc,
    params$atfm,
    params$ldgsum,
    params$latest
  )

  out %>%
    datatable(
      options = list(
        dom = "t",
        pageLength = nrow(out),
        ordering = FALSE,
        columnDefs = list(list(
          className = "dt-center",
          targets = "_all"
        )),
        fnDrawCallback = htmlwidgets::JS("function(){HTMLWidgets.staticRender();}")
      ),
      escape = FALSE,
      colnames = c(
        "Indicator",
        "Year 2019",
        "Most Recent Month",
        "12-month Trend"
      ),
      rownames = FALSE,
      caption = htmltools::tags$caption(
        style = "caption-side: bottom; text-align: right;",
        "Performance measures (other than traffic) are typically reported for the month preceeding the previous month, i.e. July -> May. Data reported under Most Recent Month dating back further point at on-going quality validation or missing reporting."
      )
    ) %>%
    spk_add_deps()
}
```

### Daily Traffic Variation snapshot (Source: Network Manager)

```{r tfcvar-snapshot, results='asis'}
if (nrow(params$tfcvar) < 1) {
  cat("<p><b>Traffic evolution for this airport under development!</b>")
} else {
  fig1 <- params$tfcvar %>%
    plot_ly() %>%
    add_lines(
      x = ~DAY,
      y = ~FLTS,
      name = "Flights"
    ) %>%
    add_lines(
      x = ~DAY,
      y = ~FLTS_2019,
      name = "Flights 2019 (Reference)",
      line = list(
        dash = "dot",
        color = "red"
      )
    ) %>%
    layout(yaxis = list(title = "movements"))

  fig2 <- params$tfcvar %>%
    plot_ly() %>%
    add_lines(
      x = ~DAY,
      y = ~MOV_AVG_WK,
      name = " <br> % vs 2019 <br> (7-day Moving Average)"
    ) %>%
    layout(
      xaxis = list(title = ""),
      yaxis = list(
        title = "% change from 2019",
        titlefont = list(size = 11),
        tickformat = "%"
      )
      ##############################################################################
      # , annotations = list(
      #   x = 1,
      #   y = -0.1,
      #   text = "Source: Network Manager",
      #   showarrow = FALSE,
      #   xref = "paper",
      #   yref = "paper",
      #   xanchor = "right",
      #   yanchor = "auto",
      #   xshift = 0,
      #   yshift = -20,
      #   font = list(size = 12)
      # )
      ##############################################################################
    )

  fig <- subplot(fig1, fig2, nrows = 2, shareX = TRUE) %>%
    layout(hovermode = "x unified") %>%
    config(
      displaylogo = FALSE,
      modeBarButtonsToRemove = config_bar_remove_buttons
    )

  fig
}
```


# Traffic

## Row -----------------------------------------------------------

### Annual Traffic (Source: Network Manager)

```{r annual-traffic, child='R/Figures/Fig_Annual_traffic.Rmd'}

```

### Monthly Traffic (Source: Network Manager)

```{r monthly-traffic, child='R/Figures/Fig_Monthly_traffic.Rmd'}

```


## Row -----------------------------------------------------------

<!--
### Annual Variation of Daily Movements (Source: Network Manager)

```{r daily-movements}

tmp <- params$tfc %>%
  select(YEAR,
    DATE = FLT_DATE,
    FLT_DEP,
    FLT_ARR
  ) %>%
  pivot_longer(
    cols = starts_with("FLT_"),
    names_to = "PHASE",
    values_to = "MVTS"
  ) %>%
  separate(PHASE,
    into = c(NA, "PHASE", NA),
    sep = "_"
  ) %>%
  mutate(PHASE = factor(PHASE,
    levels = c("DEP", "ARR"),
    labels = c("Departures", "Arrivals")
  ))

xax <- list(title = "")

yax <- list(title = "Movements per day", titlefont = list(size = 11))

pbox_group <- tmp %>%
  plot_ly(
    x = ~YEAR,
    y = ~MVTS,
    color = ~PHASE,
    type = "box"
  ) %>%
  layout(
    boxmode = "group",
    xaxis = xax,
    yaxis = yax
    ##############################################################################
    # , annotations = list(
    #   x = 1,
    #   y = -0.1,
    #   text = "Source: Network Manager",
    #   showarrow = FALSE,
    #   xref = "paper",
    #   yref = "paper",
    #   xanchor = "right",
    #   yanchor = "auto",
    #   xshift = 0,
    #   yshift = -5,
    #   font = list(size = 12)
    # )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

pbox_group

```
-->

### Share of Market Segment (Source: Network Manager)

```{r market-segment, child='R/Figures/Fig_Market_segment.Rmd'}

```


### Average Weekday Hourly Throughput (Source: Network Manager)

```{r Avg-weekday-hourly-throughput, child='R/Figures/Fig_Avg_weekday_hourly_throughput.Rmd'}

```


# ATFM Delay

## Row -----------------------------------------------------------
### Annual Arrival ATFM Delay (Source: Network Manager)


```{r atfm-pa, child='R/Figures/Fig_Annual_Arr_ATFM_Delay.Rmd'}

```

### Monthly Arrival ATFM Delay (Source: Network Manager)

```{r atfm-pm, child='R/Figures/Fig_Monthly_Arr_ATFM_Delay.Rmd'}

```


## Row -----------------------------------------------------------

### Daily Arrival ATFM Delay (Source: Network Manager)

```{r Daily-arr-atfm-delay}
if (nrow(params$atfm) > 0) {
  tmp <- params$atfm %>%
    group_by(FLT_DATE) %>%
    summarise(
      ARRS         = sum(FLT_ARR_1, na.rm = TRUE),
      TOT_ARR_ATFM = sum(DLY_APT_ARR_1, na.rm = TRUE),
      DLYD_ARRS    = sum(FLT_ARR_1_DLY, na.rm = TRUE),
      DLYS_ARRS_15 = sum(FLT_ARR_1_DLY_15, na.rm = TRUE)
    )

  worst_day_last_year <- tmp %>%
    top_n(365, FLT_DATE) %>%
    filter(TOT_ARR_ATFM == max(TOT_ARR_ATFM, na.rm = TRUE)) %>%
    filter(FLT_DATE == max(FLT_DATE, na.rm = TRUE))

  worst_day_date <- worst_day_last_year$FLT_DATE
  worst_day_dly <- worst_day_last_year$TOT_ARR_ATFM
  worst_day_avgATFMdly <- worst_day_last_year$TOT_ARR_ATFM / worst_day_last_year$ARRS


  if (worst_day_dly == 0) {
    key_msg <- ""
    showar  <- FALSE
  } else {
    key_msg <- paste0(
      "<b>Latest worst day in last 12 months: ", worst_day_date,
      "<br>with total Arrival ATFM delay: ", worst_day_dly, "min",
      "<br>(avg. Arrival ATFM Delay: ", round(worst_day_avgATFMdly, 2), "min)</b>"
    )
    showar  <- TRUE
  }

  p <- tmp %>%
    plot_ly(
      x       = ~FLT_DATE,
      y       = ~TOT_ARR_ATFM,
      type    = "scatter",
      mode    = "lines",
      line    = list(
        shape = "hvh",
        width = 1
      )
    ) %>%
    add_annotations(
      text      = key_msg,
      x         = worst_day_date,
      y         = worst_day_dly,
      showarrow = showar,
      ax        = -50,
      ay        = -50,
      align     = "right"
    ) %>%
    layout(
      xaxis = list(
        title = "",
        rangeslider = list(type = "date")
      ),
      yaxis = list(
        title = "Arrival ATFM delay [min]",
        titlefont = list(size = 11)
      )
      ##############################################################################
      # ,
      # annotations = list(
      #   x         = 1,
      #   y         = -0.1,
      #   text      = "Source: Network Manager",
      #   showarrow = FALSE,
      #   xref      = "paper",
      #   yref      = "paper",
      #   xanchor   = "right",
      #   yanchor   = "auto",
      #   xshift    = 0,
      #   yshift    = -95,
      #   font      = list(size = 12)
      # )
      ##############################################################################
    ) %>%
    config(
      displaylogo = FALSE,
      modeBarButtonsToRemove = config_bar_remove_buttons
    )

  p
}
```

### Share of ATFM Delay (Source: Network Manager)

```{r atfm-ytd}
if (nrow(params$atfm) > 0) {
  atfm_max_year <- atfm_pm %>%
    pull(YEAR) %>%
    max() %>%
    unique()

  share_atfm <- atfm_pm %>%
    filter(YEAR == atfm_max_year) %>%
    group_by(REG_REASON) %>%
    summarise(
      FLT_ARR_TOT = sum(FLT_ARR_TOT, na.rm = TRUE),
      DLY         = sum(DLY, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    mutate(
      DLY_TOT   = sum(DLY, na.rm = TRUE),
      DLY_SHARE = round(DLY / DLY_TOT, 2),
      LABELS    = paste0(REG_REASON, "<br>", DLY_SHARE, "%")
    ) %>%
    filter(DLY_SHARE > 0)

  center_text <- paste0("<b>", atfm_max_year, "</b>")

  share_atfm %>%
    plot_ly(
      labels = ~REG_REASON,
      values = ~DLY_SHARE
    ) %>%
    add_pie(
      hole         = 0.4,
      textposition = "outside"
    ) %>%
    add_annotations(
      text      = center_text,
      font      = list(size = 18),
      x         = 0.5,
      y         = 0.5,
      showarrow = FALSE
    ) %>%
    config(
      displaylogo = FALSE,
      modeBarButtonsToRemove = config_bar_remove_buttons
    )
}

```

# ATFM Slot

## Row -----------------------------------------------------------

### Annual Regulated Departures (Source: Network Manager)

```{r ANNUAL-ATFM-REG}
SLOT_YY_PLOT1 <- params$slot_yy %>%
  select(
    AIRPORT,
    YEAR,
    TOT_FLT_DEP_1,
    TOT_FLT_DEP_REG_1,
    TOT_FLT_DEP_OUT_EARLY_1,
    TOT_FLT_DEP_OUT_LATE_1,
    TOT_FLT_DEP_REG_1
  ) %>%
  mutate(
    PCT_DEP_REG = (TOT_FLT_DEP_REG_1 / TOT_FLT_DEP_1) * 100,
    PCT_DEP_OUT = ((TOT_FLT_DEP_OUT_EARLY_1 + TOT_FLT_DEP_OUT_LATE_1) / TOT_FLT_DEP_REG_1) * 100
  ) %>%
  select(YEAR, PCT_DEP_REG, PCT_DEP_OUT)


SLOT_YY_PLOT1 <- SLOT_YY_PLOT1 %>%
  mutate(YEAR = as.character(YEAR))


SLOT_YY_PLOT1 %>%
  plot_ly(
    x      = ~YEAR,
    y      = ~PCT_DEP_REG,
    type   = "bar",
    marker = list(color = "rgb(201, 201, 201)"),
    name   = "Share of ATFM<br>regulated departures"
  ) %>%
  add_markers(
    x        = ~YEAR,
    y        = ~PCT_DEP_OUT,
    name     = "Share of Outside STW",
    marker   = list(
      symbol = "square",
      color  = "rgb(192, 0, 0)",
      size   = 10
    )
  ) %>%
  layout(
    hovermode = "x unified",
    xaxis     = list(title = ""),
    yaxis     = list(
      title       = "Percentage of departures",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    )
    ##############################################################################
    # ,annotations = list(
    #   x         = 1,
    #   y         = -0.1,
    #   text      = "Source: Network Manager",
    #   showarrow = FALSE,
    #   xref      = "paper",
    #   yref      = "paper",
    #   xanchor   = "right",
    #   yanchor   = "auto",
    #   xshift    = 0,
    #   yshift    = -5,
    #   font      = list(size = 12)
    # )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )


```

### Monthly Regulated Departures (Source: Network Manager)
```{r MONTHLY-ATFM-REG}
SLOT_MM_PLOT1 <- params$slot_mm %>%
  select(
    AIRPORT,
    YEAR,
    MONTH_NUM,
    TOT_FLT_DEP_1,
    TOT_FLT_DEP_REG_1,
    TOT_FLT_DEP_OUT_EARLY_1,
    TOT_FLT_DEP_OUT_LATE_1,
    TOT_FLT_DEP_REG_1
  ) %>%
  mutate(
    PCT_DEP_REG = (TOT_FLT_DEP_REG_1 / TOT_FLT_DEP_1) * 100,
    PCT_DEP_OUT = ((TOT_FLT_DEP_OUT_EARLY_1 + TOT_FLT_DEP_OUT_LATE_1) / TOT_FLT_DEP_REG_1) * 100
  ) %>%
  select(YEAR, MONTH_NUM, PCT_DEP_REG, PCT_DEP_OUT)
# %>%
#                  tidyr::pivot_longer(cols  = c(PCT_DEP_REG ,PCT_DEP_OUT),
#                                      names_to  = "PCT_CAT",
#                                      values_to = "PCT_VAL")

# pct_col <- c("#c9c9c9","#C00000")

# SLOT_YY_PLOT1$PCT_CAT <- factor(SLOT_YY_PLOT1$PCT_CAT,
#                           levels=c( "PCT_DEP_REG","PCT_DEP_OUT"),
#                           labels=c( "Share of ATFM<br>regulated departures","Share of Outside STW"))

filter_years <- SLOT_YY_PLOT1 %>%
  pull(YEAR) %>%
  unique()

max_year <- max(filter_years)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)

# SLOT_YY_PLOT1 %>%
#  plot_ly(x          = ~MONTH_NUM,
#          y          = ~PCT_VAL,
#          customdata = ~YEAR,
#          color      = ~PCT_CAT,
#          colors     = pct_col,
#          type       = "bar",
#          transforms = list(list(type      = 'filter',
#                                 target    = "customdata",
#                                 operation = '=',
#                                 value     = max_year)
#                           )
#         ) %>%
#  layout( barmode     = "group",
#          hovermode   = "x unified",
#          xaxis       = tick_yr_no_title,
#          yaxis       = list( title="Percentage of departures",
#                              titlefont = list(size = 11),
#                              hoverformat = ".2f"),
#          showlegend  = TRUE,
#          updatemenus = list( button_type_list )
#         ) %>%
#  config( displaylogo = FALSE,
#        modeBarButtonsToRemove = config_bar_remove_buttons)

SLOT_MM_PLOT1 %>%
  plot_ly(
    x          = ~MONTH_NUM,
    y          = ~PCT_DEP_REG,
    customdata = ~YEAR,
    type       = "bar",
    marker     = list(color = "rgb(201, 201, 201)"),
    name       = "Share of ATFM<br>regulated departures",
    transforms = list(
      list(
        type      = "filter",
        target    = "customdata",
        operation = "=",
        value     = max_year
      )
    )
  ) %>%
  add_markers(
    x        = ~MONTH_NUM,
    y        = ~PCT_DEP_OUT,
    name     = "Share of Outside STW",
    marker   = list(
      symbol = "square",
      color  = "rgb(192, 0, 0)",
      size   = 10
    )
  ) %>%
  layout(
    hovermode = "x unified",
    xaxis = tick_yr_no_title,
    yaxis = list(
      title = "Percentage of departures",
      titlefont = list(size = 11),
      hoverformat = ".2f"
    ),
    showlegend = TRUE,
    updatemenus = list(button_type_list)
    ##############################################################################
    # ,annotations = list(
    #   x         = 1,
    #   y         = -0.1,
    #   text      = "Source: Network Manager",
    #   showarrow = FALSE,
    #   xref      = "paper",
    #   yref      = "paper",
    #   xanchor   = "right",
    #   yanchor   = "auto",
    #   xshift    = 0,
    #   yshift    = -10,
    #   font      = list(size = 12)
    # )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )


```

## Row -----------------------------------------------------------

### Annual ATFM Slot Adherence (Source: Network Manager)

```{r ANNUAL-ATFM-SLOT2, child='R/Figures/Fig_Annual_ATFM_Slot.Rmd'}

```

### Monthly ATFM Slot Adherence (Source: Network Manager)

```{r MONTHLY-ATFM-SLOT2, child='R/Figures/Fig_Monthly_ATFM_Slot.Rmd'}

```

# CDO/CCO

```{r cdo-cco-data-check, results='asis', eval=nrow(params$cdo_cco)==0}

cat("Analyses on vertical flight efficiency during climb and descent for ", params$icao, " are not available. Please contact pru-support@eurocontrol.int for further information.")
  
```

  
```{r cdo-cco-row1, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r cdo-cco-title1, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

cat("### Average time flown level per flight (Source: AIU analysis)")

```

  
```{r Avg-time-lvl, child='R/Figures/Fig_Avg_time_lvl.Rmd'}

```


```{r cdo-cco-title2, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

cat("### Median CDO/CCO altitudes (Source: AIU analysis)")

```


```{r Med-CDO-CCO-alt, child='R/Figures/Fig_Med_CDO_CCO_alt.Rmd'}

```


```{r cdo-cco-row2, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r cdo-cco-title3, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

cat("### Share of CDO/CCO flights (Source: AIU analysis)")

```


```{r Share-unimpeded, child='R/Figures/Fig_Share_unimpeded_CDO_CCO.Rmd'}

```



```{r cdo-cco-title4, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

cat("### Median CDO/CCO altitudes vs. Average time flown level per flight (Source: AIU analysis)")

```


```{r Med-CDO-CCO-alt-avg-time-lvl, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

MED_CDO_CCO_ALT_AVG_TIME_LVL_PLOT <- params$cdo_cco %>% 
    select(YEAR, MONTH_NUM, AVG_TIME_LVL_DESCENT, AVG_TIME_LVL_CLIMB, MEDIAN_CDO_ALT, MEDIAN_CCO_ALT) %>% 
    mutate(Date=as.factor(as.POSIXct(paste0(YEAR, "-", MONTH_NUM, "-01"), "%d/%m/%Y")))
  
plot_ly(MED_CDO_CCO_ALT_AVG_TIME_LVL_PLOT,
        x = ~AVG_TIME_LVL_DESCENT/60,
        y = ~MEDIAN_CDO_ALT,
        marker = list(color = 'rgb(40, 120, 181)'),
        hovertemplate = "%{x:.1f} min/flight <br>%{y:.0f} feet",
        frame = ~Date,
        name = 'Descent (Fuel CDO)',
        type = 'scatter',
        mode = 'markers',
        showlegend = T
) %>% 
  add_trace(x = ~AVG_TIME_LVL_CLIMB/60, 
            y = ~MEDIAN_CCO_ALT,
            marker = list(color = 'rgb(106, 168, 82)'),
            name = 'Climb (Fuel CCO)') %>%
  layout(xaxis       = list( title="Average time flown level per flight (min.)",
                             titlefont = list(size = 11),
                             range = c(0, max(max(MED_CDO_CCO_ALT_AVG_TIME_LVL_PLOT$AVG_TIME_LVL_DESCENT),
                                              max(MED_CDO_CCO_ALT_AVG_TIME_LVL_PLOT$AVG_TIME_LVL_CLIMB)))/60),
         yaxis       = list( title="Median CDO/CCO altitude (feet)",
                             titlefont = list(size = 11),
                             range = c(0, max(max(MED_CDO_CCO_ALT_AVG_TIME_LVL_PLOT$MEDIAN_CDO_ALT),
                                              max(MED_CDO_CCO_ALT_AVG_TIME_LVL_PLOT$MEDIAN_CCO_ALT)))),
         showlegend  = TRUE
         ##############################################################################
         # ,annotations = list(
         #   x         = 1, 
         #   y         = -0.1, 
         #   text      = "Source: AIU analysis", 
         #   showarrow = F, 
         #   xref      = 'paper', 
         #   yref      = 'paper', 
         #   xanchor   = 'right', 
         #   yanchor   = 'auto', 
         #   xshift    = 0, 
         #   yshift    = -10,
         #   font      =list(size=12)
         # )          
         ##############################################################################
  ) %>% 
  config( displaylogo = FALSE,
          modeBarButtonsToRemove = config_bar_remove_buttons)

```

# ASMA Time

```{r ASMA-time-data-check, results='asis', eval=params$apdf != "Y"}

cat("<center> 
Analyses on approach times are only available for airports providing the required data 
using the Airport Operator Data Flow (APDF).

If you belong to the airport and would like to implement such data flow, please contact DANSAP@eurocontrol.int </center>")
  
```

  
```{r ASMA-time-row1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r ASMA-time-title1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual ASMA Time (Source: APDF)")

```


```{r ASMA-YEARLY-LAYOUT, child='R/Figures/Fig_ASMA_yearly.Rmd'}

```

  
```{r ASMA-time-title2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly ASMA Time (Source: APDF)")

```


```{r ASMA-MONTHLY-LAYOUT, child='R/Figures/Fig_ASMA_monthly.Rmd'}

```

  
```{r ASMA-time-row2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```


<!-- 


```{r ASMA-time-title3, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly ASMA Trend (current Year)")

```


```{r ASMA-TREND-LAYOUT, results='asis', eval=params$apdf == "Y", echo = FALSE}

TMP <- params$asma_mm %>% 
mutate( DATE_YM = paste0(YEAR,"-",MONTH_NUM),
DATE_YM = lubridate::parse_date_time(DATE_YM, "ym"))

TMP %>% 
plot_ly(x    = ~DATE_YM, 
y    = ~AVG_ADD_TIME, 
type = 'scatter',
mode = 'lines', 
line = list(shape = "hvh", 
width = 1)) %>%
layout( hoverformat = ".2f",
xaxis = list(title = "", 
rangeselector = list(buttons = list(list(count = 3,
label = "3 mo",
step = "month",
stepmode = "backward"),
list(count = 6,
label = "6 mo",
step = "month",
stepmode = "backward"),
list(count = 1,
label = "1 yr",
step = "year",
stepmode = "backward"),
list(count = 1,
label = "YTD",
step = "year",
stepmode = "todate"),
list(step = "all"))),
rangeslider = list(type = "date")), 
yaxis = list(title = "Additional Average ASMA time [min/arr]",
titlefont = list(size = 11))) %>% 
config( displaylogo = FALSE,
modeBarButtonsToRemove = config_bar_remove_buttons)

```

-->


# Taxi-Out Time

```{r Taxi-out-time-data-check, results='asis', eval=params$apdf != "Y"}

cat("<center> 
Analyses on taxi-out times are only available for airports providing the required data 
using the Airport Operator Data Flow (APDF).

If you belong to the airport and would like to implement such data flow, please contact DANSAP@eurocontrol.int </center>")
  
```

  
```{r Taxi-out-time-row1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r Taxi-out-time-title1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual Taxi-Out Time (Source: APDF)")

```


```{r TXOT-YEARLY-LAYOUT, child='R/Figures/Fig_Taxi_out_yearly.Rmd'}

```

  
```{r Taxi-out-time-title2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly Taxi-Out Time (Source: APDF)")

```


```{r TAXI-OUT-MONTHLY-LAYOUT, child='R/Figures/Fig_Taxi_out_monthly.Rmd'}

```


```{r Taxi-out-time-row2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```



# Taxi-In Time

```{r Taxi-in-time-data-check, results='asis', eval=params$apdf != "Y"}

cat("<center> 
Analyses on taxi-in times are only available for airports providing the required data 
using the Airport Operator Data Flow (APDF).

If you belong to the airport and would like to implement such data flow, please contact DANSAP@eurocontrol.int </center>")
  
```

  
```{r Taxi-in-time-row1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r Taxi-in-time-title1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual Taxi-In Time (Source: APDF)")

```


```{r TXIN-YEARLY-LAYOUT, child='R/Figures/Fig_Taxi_in_yearly.Rmd'}

```


```{r Taxi-in-time-title2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly Taxi-In Time (Source: APDF)")

```


```{r TAXI-IN-MONTHLY-LAYOUT, child='R/Figures/Fig_Taxi_in_monthly.Rmd'}

```


```{r Taxi-in-time-row2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```


# Pre-Dep Delay

```{r Pre-dep-delay-data-check, results='asis', eval=params$apdf != "Y"}

cat("<center> 
Analyses on pre-departure delay are only available for airports providing the required data 
using the Airport Operator Data Flow (APDF).

If you belong to the airport and would like to implement such data flow, please contact DANSAP@eurocontrol.int </center>")
  
```

  
```{r Pre-dep-delay-row1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r Pre-dep-delay-title1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual Pre-Departure Delay (Source: APDF)")

```


```{r pre-dep-dly-pa, child='R/Figures/Fig_Pre_departure_delay_yearly.Rmd'}

```


```{r Pre-dep-delay-title2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly Pre-Departure Delay (Source: APDF)")

```


```{r pre-dep-dly-month, child='R/Figures/Fig_Pre_departure_delay_monthly.Rmd'}

```

```{r Pre-dep-delay-row2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```


<!-- 

### Monthly Pre-Departure Delay Trend

```{r Monthly-pre-dep-delay, results='asis', eval=params$apdf == "Y", echo = FALSE}


TMP <- PDDLY_MM %>%
mutate( DATE_YM = paste0(YEAR,"-",MONTH_NUM),
DATE_YM = lubridate::parse_date_time(DATE_YM, "ym") )

TMP %>%
plot_ly() %>%
add_bars(x     = ~DATE_YM, 
y     = ~DLY_DUR, 
color = ~DLY_CAT,
hovertemplate = "%{y:.r}") %>%
layout(barmode = "stack",
xaxis = list(title = "",
rangeselector = list(buttons = list(list(count    = 3,
label    = "3 mo",
step     = "month",
stepmode = "backward"),
list(count    = 6,
label    = "6 mo",
step     = "month",
stepmode = "backward"),
list(count    = 1,
label    = "1 yr",
step     = "year",
stepmode = "backward"),
list(count    = 1,
label    = "YTD",
step     = "year",
stepmode = "todate"),
list(step     = "all"))),
rangeslider = list(type = "date")
), 
yaxis = list( title = "Pre-Departure delay [min]",
titlefont = list(size = 11))) %>% 
config( displaylogo = FALSE,
modeBarButtonsToRemove = config_bar_remove_buttons)


```

-->

```{r Pre-dep-delay-title3, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual Average ATC Pre-Departure Delay (Source: APDF)")

```


```{r pre-dep-dly-year-atc, results='asis', eval=params$apdf == "Y", echo = FALSE}

predepdly_py <- params$pddly_yy_avg %>%
  mutate(YEAR = as.character(YEAR))

predepdly_py %>%
  plot_ly(
    x     = ~YEAR,
    y     = ~DLY_89_PER_FL_YY, #AVG_PREDEP_DLY,
    type  = "bar",
    color = I("steelblue")
  ) %>%
  layout(
    xaxis = list(title = ""),
    yaxis = list(
      title       = "Avg. ATC Pre-Departure delay [min/dep]",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    )
    ##############################################################################
    # ,annotations = list(
    #   x         = 1,
    #   y         = -0.1,
    #   text      = "Source: APDF",
    #   showarrow = FALSE,
    #   xref      = "paper",
    #   yref      = "paper",
    #   xanchor   = "right",
    #   yanchor   = "auto",
    #   xshift    = 0,
    #   yshift    = -5,
    #   font      = list(size = 12)
    # )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```


```{r Pre-dep-delay-title4, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly Average ATC Pre-Departure Delay (Source: APDF)")

```


```{r pre-dep-indicator, results='asis', eval=params$apdf == "Y", echo = FALSE}

predepdly_pm <- params$pddly_mm_avg %>%
  select(YEAR, MONTH_NUM, DLY_89_PER_FL_MM)

filter_years <- predepdly_pm %>%
  pull(YEAR) %>%
  unique()

max_year <- max(filter_years)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)


predepdly_pm %>%
  plot_ly(
    x          = ~MONTH_NUM,
    y          = ~DLY_89_PER_FL_MM,
    customdata = ~YEAR,
    color      = I("steelblue"),
    type       = "bar",
    transforms = list(
      list(
        type      = "filter",
        target    = "customdata",
        operation = "=",
        value     = max_year
      )
    )
  ) %>%
  layout(
    barmode = "stack",
    xaxis   = tick_yr_no_title,
    yaxis   = list(
      title       = "Avg. ATC Pre-Departure delay [min/dep]",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    ),
    showlegend  = FALSE,
    updatemenus = list(button_type_list)
    ##############################################################################
    # ,annotations = list(
    #   x         = 1,
    #   y         = -0.1,
    #   text      = "Source: APDF",
    #   showarrow = FALSE,
    #   xref      = "paper",
    #   yref      = "paper",
    #   xanchor   = "right",
    #   yanchor   = "auto",
    #   xshift    = 0,
    #   yshift    = -10,
    #   font      = list(size = 12)
    # )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```


# Punctuality


```{r punctuality-data-check, results='asis', eval=params$punc != "Y"}

cat("<center>
Analyses on punctuality are only available for airports providing the required data 
using the Airport Operator Data Flow (APDF).

If you belong to the airport and would like to implement such data flow, please contact DANSAP@eurocontrol.int </center>")

```

  
```{r punctuality-row1, results='asis', eval=params$punc == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r punctuality-title1, results='asis', eval=params$punc == "Y", echo = FALSE}

cat("### Annual Departure Punctuality (Source: APDF)")

```

  
```{r Punctuality-DEP-YEARLY-LAYOUT, child='R/Figures/Fig_Punctuality_Dep_yearly_layout.Rmd'}

```


```{r punctuality-title2, results='asis', eval=params$punc == "Y", echo = FALSE}

cat("### Monthly Departure Punctuality (Source: APDF)")

```


```{r Punctuality-DEP-MONHTLY-LAYOUT, child='R/Figures/Fig_Punctuality_Dep_monthly_layout.Rmd'}

```


```{r punctuality-row2, results='asis', eval=params$punc == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r punctuality-title3, results='asis', eval=params$punc == "Y", echo = FALSE}

cat("### Annual Arrival Punctuality (Source: APDF)")

```


```{r Punctuality-ARR-YEARLY-LAYOUT, child='R/Figures/Fig_Punctuality_Arr_yearly_layout.Rmd'}

```


```{r punctuality-title4, results='asis', eval=params$punc == "Y", echo = FALSE}

cat("### Monthly Arrival Punctuality (Source: APDF)")

```


```{r Punctuality-ARR-MONHTLY-LAYOUT, child='R/Figures/Fig_Punctuality_Arr_monthly_layout.Rmd'}

```


# Turnaround Times


```{r Turnaround-times-data-check, results='asis', eval=params$apdf != "Y"}

cat("<center> 
Analyses on turnaround times are only available for airports providing the required data 
using the Airport Operator Data Flow (APDF).

If you belong to the airport and would like to implement such data flow, please contact DANSAP@eurocontrol.int </center>")
  
```

  
```{r Turnaround-times-row1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r Turnaround-times-title1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual Actual Turnaround Time (Source: APDF)")

```


```{r annual-turn-time, results='asis', eval=params$apdf == "Y", echo = FALSE}

TURN_YY <- params$turn_yy %>%
  select(YEAR, AC_CLASS, AVG_ACTT)

turn_col <- c(
  "#C6E0B4", # RGB 198,224,180 # Heavy
  "#F8CBAD", # RGB 248,203,173 # Medium Jet
  "#BDD7EE"
) # RGB 189,215,238 # Medium Turboprop

TURN_YY$AC_CLASS <- factor(TURN_YY$AC_CLASS,
                           levels = c("H", "MJ", "MT"),
                           labels = c("Heavy", "Medium Jet", "Medium Turboprop")
)

TURN_YY <- TURN_YY %>%
  mutate(YEAR = as.character(YEAR))


TURN_YY %>%
  plot_ly(
    x      = ~YEAR,
    y      = ~AVG_ACTT,
    type   = "bar",
    color  = ~AC_CLASS,
    colors = turn_col
  ) %>%
  layout(
    barmode   = "group",
    hovermode = "x unified",
    xaxis     = list(title = ""),
    yaxis     = list(
      title       = "Average Actual Turnaround time [min/flight]",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    )
    ##############################################################################
    # ,annotations = list(
    #   x         = 1,
    #   y         = -0.1,
    #   text      = "Source: APDF",
    #   showarrow = FALSE,
    #   xref      = "paper",
    #   yref      = "paper",
    #   xanchor   = "right",
    #   yanchor   = "auto",
    #   xshift    = 0,
    #   yshift    = -5,
    #   font      = list(size = 12)
    # )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```


```{r Turnaround-times-title2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly Turnaround Times (Source: APDF)")

```


```{r monthly-turn-time, results='asis', eval=params$apdf == "Y", echo = FALSE}

TURN_MM <- params$turn_mm %>%
  select(YEAR, MONTH_NUM, TOT_TURN, AC_CLASS, AVG_ACTT, AVG_SDTT) %>%
  mutate(
    LBL_ACTUAL = paste0("Actual Turnaround ", AC_CLASS),
    LBL_SCHED = paste0("Scheduled Turnaround ", AC_CLASS),
    HOVERTEXTACTT = paste0(
      "Class: ", AC_CLASS,
      "<br>Avg. Turn:", round(AVG_ACTT, 2), "min",
      "<br>Nb Turn. :", TOT_TURN
    ),
    HOVERTEXTSDTT = paste0(
      "Class: ", AC_CLASS,
      "<br>Avg. Turn:", round(AVG_SDTT, 2), "min",
      "<br>Nb Turn. :", TOT_TURN
    )
  )

filter_years <- TURN_MM %>%
  pull(YEAR) %>%
  unique()

max_year <- max(filter_years)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)


TURN_MM %>%
  plot_ly() %>%
  add_lines(
    x          = ~MONTH_NUM,
    y          = ~AVG_ACTT,
    color      = ~AC_CLASS,
    colors     = turn_col,
    name       = ~LBL_ACTUAL,
    customdata = ~YEAR,
    transforms = list(
      list(
        type      = "filter",
        target    = "customdata",
        operation = "=",
        value     = max_year
      )
    ),
    text          = ~HOVERTEXTACTT,
    hovertemplate = paste0("%{text}"),
    legendgroup   = ~AC_CLASS,
    showlegend    = TRUE
  ) %>%
  add_lines(
    x          = ~MONTH_NUM,
    y          = ~AVG_SDTT,
    color      = ~AC_CLASS,
    colors     = turn_col,
    name       = ~LBL_SCHED,
    line       = list(dash = "dash"),
    customdata = ~YEAR,
    transforms = list(
      list(
        type      = "filter",
        target    = "customdata",
        operation = "=",
        value     = max_year
      )
    ),
    text          = ~HOVERTEXTSDTT,
    hovertemplate = paste0("%{text}"),
    legendgroup = ~AC_CLASS,
    showlegend = TRUE
  ) %>%
  layout(
    updatemenus = list(button_type_list),
    hovermode   = "x unified",
    xaxis       = tick_yr_no_title,
    yaxis       = list(
      title     = "Average Turnaround times [min/flight]",
      titlefont = list(size = 11)
    )
    ##############################################################################
    # ,annotations = list(
    #   x         = 1,
    #   y         = -0.1,
    #   text      = "Source: APDF",
    #   showarrow = FALSE,
    #   xref      = "paper",
    #   yref      = "paper",
    #   xanchor   = "right",
    #   yanchor   = "auto",
    #   xshift    = 0,
    #   yshift    = -10,
    #   font      = list(size = 12)
    # )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```


```{r Turnaround-times-row2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

<!--
  
```{r Turnaround-times-title3, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### DDI-G and TDI (Source: APDF)")

```


```{r delay-difference-indicator, results='asis', eval=params$apdf == "Y", echo = FALSE}

TURN_DDI <- params$turn_new %>%
    select(YEAR, MONTH_NUM, AVG_ADTT, AVG_ERTT)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)

plot_ly(TURN_DDI, 
        x           = ~MONTH_NUM, 
        y           = ~AVG_ADTT, 
        customdata  = ~YEAR, 
        type        = "bar",
        marker = list(color = 'rgb(40, 120, 181)'),
        name = 'DDI-G',
        transforms  = list(list(type     = 'filter',
                               target    = "customdata",
                               operation = '=',
                               value     = max_year)
                          )
        ) %>% 
    add_trace(y      = ~AVG_ERTT, 
              marker = list(color = 'rgb(106, 168, 82)'),
              name   = 'TDI') %>%
  layout(barmode     = 'group',
         hovermode   = "x unified",
         xaxis       = tick_yr_no_title,
         yaxis       = list( title="Average minutes difference per rotation",
                             titlefont = list(size = 11),
                             hoverformat = ".2f"),
         updatemenus = list( button_type_list ),
         showlegend = TRUE
         ) %>% 
  config( displaylogo = FALSE,
          modeBarButtonsToRemove = config_bar_remove_buttons)

```

  
```{r Turnaround-times-title4, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Share of GTO (Ground Time Overshoot) (Source: APDF)")

```


```{r ground-time-overshoot, results='asis', eval=params$apdf == "Y", echo = FALSE}

TURN_OVER <- params$turn_new %>%
    select(YEAR, MONTH_NUM, AVG_OVER)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)

plot_ly(TURN_OVER, 
        x           = ~MONTH_NUM, 
        y           = ~AVG_OVER*100, 
        customdata  = ~YEAR, 
        marker = list(color = 'rgb(106, 168, 82)'),
        hovertemplate = "%{y:.1f}%",
        type        = "bar",
        name = '',
        transforms  = list(list(type     = 'filter',
                               target    = "customdata",
                               operation = '=',
                               value     = max_year)
                          )
        ) %>% 
  layout(barmode     = 'group',
         hovermode   = "x unified",
         xaxis       = tick_yr_no_title,
         yaxis       = list( title="Share of GTO (Ground Time Overshot)",
                             titlefont = list(size = 11),
                             ticksuffix = "%",  
                             range = c(0, 100)
                             ),
         updatemenus = list( button_type_list ),
         showlegend = FALSE
         ) %>% 
  config( displaylogo = FALSE,
          modeBarButtonsToRemove = config_bar_remove_buttons)
```

-->

# About

## Row ------------------------------------------------------------------

### Powered by

![](https://ansperformance.eu/images/eurocontrol-logo.png){width=30%}


### About this Dashboard

This data is published by the EUROCONTROL Performance Review Unit (PRU) in the interest of the exchange of information. 
It may be copied in whole or in part providing that this copyright notice © and disclaimer are included. 
The information may not be modified without prior written permission from the EUROCONTROL Performance Review Unit.
The information does not necessarily reflect the official views or policy of EUROCONTROL, which makes no warranty, either implied or expressed, for the information contained in this document, including its accuracy, completeness or usefulness.
Every effort has been made to ensure that the information and analysis contained on this website are as accurate and complete as possible. Despite these precautions, should you find any errors or inconsistencies or if you have any questions then please contact us at: Performance Review Unit (PRU-Support@eurocontrol.int).

### About Performance Review Unit

The PRU is responsible for monitoring and reviewing the performance of the Pan-European ANS system across a number of key performance areas.
As part of the EUROCONTROL Agency, the PRU supports the independent Performance Review Commission (PRC) in running the EUROCONTROL Performance Review System and executing the associated PRC work programme with the appropriate level of independence.
The PRU also provides support to the European Commission (EC) on the SES Performance and Charging Schemes.
In performing its tasks, the PRU maintains transparent working arrangements with service providers, airspace user organisations and the industry.
Although the PRU is independent, it is administratively reporting to the Directorate European Civil-Military Aviation (DECMA).
For feedback or questions please contact us at: Performance Review Unit (PRU-Support@eurocontrol.int).

## Row ------------------------------------------------------------------

### Data and Methodology

This dashboard is updated on a monthly basis.  

IFR traffic data and ATFM delay related data is extracted from the Network Manager.
CDO/CCO data are calculated by the Aviation Intelligence Unit of EUROCONTROL based on Network Manager data.
All other airport related data is collected through the Airport Operator Data Flow (APDF). Under the APDF airports are required to report flight-by-flight data on a monthly basis. The data is reported during the month following the month of operations. Thus, typically, APDF data becomes available the 2nd month following the month of operation.

**Data and metrics are shown based on availability at the moment of publication**    

* Traffic data comprises all IFR flown flight plans for the airport (arrivals and departures) based on NM data.
*	ATFM delay data captures the arrival ATFM delay triggered by constraints at the airport based on NM data (_no post ops adjustments_).
*	ATFM delays are grouped according to the regulation reason as described in https://ansperformance.eu/definition/atfm-delay-codes/
* CDO/CCO performance is calculated by identifying level segments during the climb and descent. These level segments are considered to be inefficient. For more information please visit https://ansperformance.eu/efficiency/vfe/
*	Additional ASMA time measures the difference between an observed travel time elapsing from entering the 40NM radius around the airport to landing. This time is compared against a reference time to the respective entry sector, aircraft type, and landing runway.
For more information please visit https://ansperformance.eu/methodology/additional-asma-time-pi/
*	In analogy, additional taxi-times are measured for the taxi-out and taxi-in phase. The observed taxi times are compared with a respective reference time. The reference time considers the parking position and runway used by the departure/arrival.
For more information please visit https://ansperformance.eu/definition/additional-taxi-out-time/
*	Pre-departure delay is the delay in the off-block time with respect to the schedule time for departure. It provides for the airspace user reported delay reasoning in case of departures blocking off late. Delay codes have to be provided for delays >= 4 minutes. Most airports per se do not validate these delay codes, however, effort is underway to ensure appropriateness of the reported delay codes.Delay reasons are reported according to the IATA delay codes https://ansperformance.eu/library/iata-delay-codes.pdf 
Delay reported associated to code 89 is used for the calculation of the ATC pre-departure delay https://ansperformance.eu/definition/atc-pre-departure-delay/ 
*	Turnaround shows the time elapsing between an aircraft blocking in and blocking off for the next flight from the same parking stand on the same day and the sample is treated to filter out.