---
params:
   icao:         $icao
   iata:         $iata
   name:         $name
   state:        $state
   apdf:         $apdf   
   config:       $config
   ldgsum:       $ldgsum
   latest:       $latest
   tfcvar:       $tfcvar
   tfc:          $tfc
   thru:         $thru
   atfm:         $atfm   
   slot_yy:      $slot_yy
   slot_mm:      $slot_mm      
   punc_dep_yy:  $punc_dep_yy
   punc_dep_mm:  $punc_dep_mm
   punc_arr_yy:  $punc_arr_yy
   punc_arr_mm:  $punc_arr_mm
   asma_yy:      $asma_yy
   asma_mm:      $asma_mm
   txot_yy:      $txot_yy
   txot_mm:      $txot_mm
   txin_yy:      $txin_yy
   txin_mm:      $txin_mm
   pddly_yy:     $pddly_yy
   pddly_mm:     $pddly_mm  
   pddly_avg:    $pddly_avg
   pddly_yy_avg: $pddly_yy_avg
   turn_yy:      $turn_yy
   turn_mm:      $turn_mm
   cdo_cco:      $cdo_cco

title         : "`r params$icao`"
author        : "AIU Home"

output: 
  flexdashboard ::flex_dashboard:
    orientation : rows
    logo        : '/images/euctrl-logo-noname_48x48.png'
    favicon     : 'favicon.png'
    lib_dir     : 'docs/libs'
    self_contained: FALSE
---

<script>
$('.navbar-logo').wrap('<a href="https://www.eurocontrol.int">');
$('.navbar-author').wrap('<a href="https://ansperformance.eu">');
</script>

<style>
.navbar-author {color: white;}
</style>

```{r setup, include=FALSE}
library(flexdashboard)
library(DT)
library(ggplot2)
library(dplyr)
library(tidyr)
library(plotly)
library(magick)
library(here)
library(stringr)
```


```{r plotly-utility}
tick_yr <- list(
  dtick = 1,
  ticktext = list(
    "Jan", "Feb", "Mar", "Apr", "May", "Jun",
    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
  ),
  tickvals = list(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12),
  tickmode = "array",
  range = c(0.5, 12.5)
)

tick_yr_no_title <- list(
  title = "",
  dtick = 1,
  ticktext = list(
    "Jan", "Feb", "Mar", "Apr", "May", "Jun",
    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
  ),
  tickvals = list(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12),
  tickmode = "array",
  range = c(0.5, 12.5)
)

pick_mth <- c(
  "Jan", "Feb", "Mar", "Apr", "May", "Jun",
  "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
)

config_bar_remove_buttons <- c(
  "sendDataToCloud",
  "autoScale2d",
  "select2d",
  "lasso2d",
  "pan2d",
  "zoom2d",
  "zoomIn2d",
  "zoomOut2d",
  "zoomInGeo",
  "zoomOutGeo",
  "hoverClosestCartesian",
  "hoverCompareCartesian",
  "toggleSpikelines",
  "drawrect"
)
```

# Overview {data-icon="fa-home"}

## Row ----------------------------------------------------------
### Aerodrome Layout

```{r airport-layout}
apt_layout_file <- here("layouts", paste0(params$icao, ".png"))
if (fs::file_exists(apt_layout_file)) {
  fs::file_copy(apt_layout_file,
    paste0("docs/", params$icao, ".png"),
    overwrite = TRUE
  )
  knitr::include_graphics(paste0("docs/", params$icao, ".png"))
}
```


### General

```{r apt-id}
ID_TBL <- tribble(
  ~ITEM, ~TEXT1, ~TEXT2,
  "Airport", params$name, "",
  "ICAO/IATA", paste0(params$icao, "/", params$iata), "",
  "State", params$state, "",
  "", "", ""
)

RWY_CONFIG <- params$config %>%
  mutate(ITEM = "") %>%
  select(
    ITEM,
    TEXT1 = CONFIGURATION,
    TEXT2 = SHARE_PCT
  ) %>%
  mutate(TEXT2 = paste0(round(100 * TEXT2), "%")) %>%
  na.omit()

RWY_CONFIG$ITEM[1] <- "Configurations in 2019"

ID_TBL <- ID_TBL %>%
  bind_rows(RWY_CONFIG)

ID_TBL %>%
  datatable(
    options = list(
      dom        = "t",
      ordering   = FALSE,
      autoWidth  = TRUE,
      columnDefs = list(list(width = "150px", targets = c(0))),
      scrollX    = TRUE
    ),
    colnames  = rep("", ncol(ID_TBL)),
    rownames  = FALSE,
    selection = "none",
    caption   = htmltools::tags$caption(
      style   = "caption-side: bottom; text-align: right;",
      "Only configurations with a minimum of 3% share are shown. Source: AIU Analysis"
    )
  ) %>%
  formatStyle(names(ID_TBL), lineHeight = "70%")
```

## Row ----------------------------------------------------------
### Summary

```{r front-page-table}
if (params$apdf == "Y") {
  source(here("R", "apt_dshbd_frontpage.R"))

  out <- prepare_front_page_DT(
    params$icao,
    params$tfc,
    params$asma_mm,
    params$txot_mm,
    params$atfm,
    params$ldgsum,
    params$latest
  )

  out %>%
    datatable(
      options = list(
        dom = "t",
        pageLength = nrow(out),
        ordering = FALSE,
        columnDefs = list(list(
          className = "dt-center",
          targets = "_all"
        )),
        fnDrawCallback = htmlwidgets::JS("function(){HTMLWidgets.staticRender();}")
      ),
      escape = FALSE,
      colnames = c(
        "Indicator",
        "Year 2019",
        "Most Recent Month",
        "12-month Trend"
      ),
      rownames = FALSE,
      caption = htmltools::tags$caption(
        style = "caption-side: bottom; text-align: right;",
        "Performance measures (other than traffic) are typically reported for the month preceeding the previous month, i.e. July -> May. Data reported under Most Recent Month dating back further point at on-going quality validation or missing reporting."
      )
    ) %>%
    spk_add_deps()
} else {
  source(here("R", "apt_dshbd_frontpage.R"))

  out <- prepare_front_page_NON_APDF(
    params$icao,
    params$tfc,
    params$atfm,
    params$ldgsum,
    params$latest
  )

  out %>%
    datatable(
      options = list(
        dom = "t",
        pageLength = nrow(out),
        ordering = FALSE,
        columnDefs = list(list(
          className = "dt-center",
          targets = "_all"
        )),
        fnDrawCallback = htmlwidgets::JS("function(){HTMLWidgets.staticRender();}")
      ),
      escape = FALSE,
      colnames = c(
        "Indicator",
        "Year 2019",
        "Most Recent Month",
        "12-month Trend"
      ),
      rownames = FALSE,
      caption = htmltools::tags$caption(
        style = "caption-side: bottom; text-align: right;",
        "Performance measures (other than traffic) are typically reported for the month preceeding the previous month, i.e. July -> May. Data reported under Most Recent Month dating back further point at on-going quality validation or missing reporting."
      )
    ) %>%
    spk_add_deps()
}
```

### Daily Traffic Variation snapshot

```{r tfcvar-snapshot, results='asis'}
if (nrow(params$tfcvar) < 1) {
  cat("<p><b>Traffic evolution for this airport under development!</b>")
} else {
  fig1 <- params$tfcvar %>%
    plot_ly() %>%
    add_lines(
      x = ~DAY,
      y = ~FLTS,
      name = "Flights"
    ) %>%
    add_lines(
      x = ~DAY,
      y = ~FLTS_2019,
      name = "Flights 2019 (Reference)",
      line = list(
        dash = "dot",
        color = "red"
      )
    ) %>%
    layout(yaxis = list(title = "movements"))

  fig2 <- params$tfcvar %>%
    plot_ly() %>%
    add_lines(
      x = ~DAY,
      y = ~MOV_AVG_WK,
      name = " <br> % vs 2019 <br> (7-day Moving Average)"
    ) %>%
    layout(
      xaxis = list(title = ""),
      yaxis = list(
        title = "% change from 2019",
        titlefont = list(size = 11),
        tickformat = "%"
      )
      ##############################################################################
      , annotations = list(
        x = 1,
        y = -0.1,
        text = "Source: Network Manager",
        showarrow = FALSE,
        xref = "paper",
        yref = "paper",
        xanchor = "right",
        yanchor = "auto",
        xshift = 0,
        yshift = -20,
        font = list(size = 12)
      )
      ##############################################################################
    )

  fig <- subplot(fig1, fig2, nrows = 2, shareX = TRUE) %>%
    layout(hovermode = "x unified") %>%
    config(
      displaylogo = FALSE,
      modeBarButtonsToRemove = config_bar_remove_buttons
    )

  fig
}
```


# Traffic

## Row -----------------------------------------------------------

### Annual Traffic

```{r annual traffic}
mvts_pa <- params$tfc %>%
  select(YEAR, FLT_TOT) %>%
  group_by(YEAR) %>%
  summarise(FLT_TOT = sum(FLT_TOT, na.rm = TRUE)) %>%
  ungroup()

cum_mvts <- params$tfc %>%
  select(YEAR, MONTH_NUM, FLT_DATE, FLT_TOT) %>%
  mutate(across(c(YEAR, MONTH_NUM), as.numeric)) %>%
  filter(YEAR %in% c(max(YEAR), max(YEAR) - 1))

this_year_max_month <- cum_mvts %>%
  filter(YEAR == max(YEAR)) %>%
  pull(MONTH_NUM) %>%
  max() %>%
  unique()

cum_mvts <- cum_mvts %>%
  filter(MONTH_NUM <= this_year_max_month) %>%
  group_by(YEAR) %>%
  summarise(FLT_TOT = sum(FLT_TOT, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(CHANGE = (FLT_TOT - lag(FLT_TOT)) / lag(FLT_TOT))

msg_tmpl <- "<b>Change Jan-{mnt}<br>{yr2} vs {yr1}:<br>{pct}% </b>"

msg <- str_glue(msg_tmpl,
  mnt = pick_mth[this_year_max_month],
  yr1 = cum_mvts$YEAR[1],
  yr2 = cum_mvts$YEAR[2],
  pct = round(100 * cum_mvts[2, "CHANGE"], 2)
)

ALL_YEAR <- mvts_pa %>%
  pull(YEAR) %>%
  unique()

msg_y <- mvts_pa %>%
  filter(YEAR == as.integer(max(YEAR)) - 1) %>%
  mutate(FLT_TOT = 0.7 * FLT_TOT) %>%
  pull(FLT_TOT)

key_msg <- list(
  x = length(ALL_YEAR) - 1,
  y = msg_y,
  text = msg,
  size = 14,
  showarrow = FALSE
)

xax <- list(title = "")

yax <- list(
  title = "Number of flights",
  titlefont = list(size = 11)
)

mvts_pa <- mvts_pa %>%
  mutate(YEAR = as.character(YEAR))

mvts_pa %>%
  plot_ly(
    x = ~YEAR,
    y = ~FLT_TOT
  ) %>%
  add_trace(
    type = "bar",
    name = "Traffic",
    hoverinfo = "text",
    hovertemplate = paste("Year: %{x}", "<br>Flights: %{y:.r}")
  ) %>%
  layout(
    xaxis = xax,
    yaxis = yax,
    annotations = key_msg
  ) %>%
  add_annotations(x         = 1, 
                  y         = -0.1, 
                  text      = "Source: Network Manager", 
                  showarrow = F, 
                  xref      = 'paper', 
                  yref      = 'paper', 
                  xanchor   = 'right', 
                  yanchor   = 'auto', 
                  xshift    = 0, 
                  yshift    = -10,
                  font      = list(size=12)
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )
```

### Monthly Traffic

```{r}
mvts_pm <- params$tfc %>%
  select(YEAR, MONTH_NUM, FLT_TOT) %>%
  group_by(YEAR, MONTH_NUM) %>%
  summarise(FLT_TOT = sum(FLT_TOT, na.rm = TRUE)) %>%
  ungroup()

mvts_pm_max <- mvts_pm %>% filter(FLT_TOT == max(FLT_TOT))

msg <- paste0(
  "<b>Busiest month <br>(last 5 years): <br>",
  mvts_pm_max$MONTH_NUM, "-",
  mvts_pm_max$YEAR,
  "<br>", mvts_pm_max$FLT_TOT, "</b>"
)

xax <- tick_yr_no_title

yax <- list(
  title = "Number of flights",
  rangemode = "tozero",
  titlefont = list(size = 11)
)

mvts_pm <- mvts_pm %>%
  mutate(YEAR = as.character(YEAR))

mvts_pm %>%
  plot_ly(
    x = ~MONTH_NUM,
    y = ~FLT_TOT,
    group = ~YEAR,
    color = ~YEAR
  ) %>%
  add_trace(
    type = "scatter",
    mode = "markers+lines",
    hovertemplate = "%{y:.r}"
  ) %>%
  add_annotations(
    text = msg,
    x = mvts_pm_max$MONTH_NUM,
    y = mvts_pm_max$FLT_TOT,
    showarrow = TRUE,
    ax = 50,
    ay = 100
  ) %>%
  layout(
    xaxis = xax,
    yaxis = yax,
    hovermode = "x unified"
    ##############################################################################
    , annotations = list(
      x = 1,
      y = -0.1,
      text = "Source: Network Manager",
      showarrow = FALSE,
      xref = "paper",
      yref = "paper",
      xanchor = "right",
      yanchor = "auto",
      xshift = 0,
      yshift = -5,
      font = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )
```


## Row -----------------------------------------------------------

### Annual Variation of Daily Movements 

```{r daily movements}
tmp <- params$tfc %>%
  select(YEAR,
    DATE = FLT_DATE,
    FLT_DEP,
    FLT_ARR
  ) %>%
  pivot_longer(
    cols = starts_with("FLT_"),
    names_to = "PHASE",
    values_to = "MVTS"
  ) %>%
  separate(PHASE,
    into = c(NA, "PHASE", NA),
    sep = "_"
  ) %>%
  mutate(PHASE = factor(PHASE,
    levels = c("DEP", "ARR"),
    labels = c("Departures", "Arrivals")
  ))

xax <- list(title = "")

yax <- list(title = "Movements per day", titlefont = list(size = 11))

pbox_group <- tmp %>%
  plot_ly(
    x = ~YEAR,
    y = ~MVTS,
    color = ~PHASE,
    type = "box"
  ) %>%
  layout(
    boxmode = "group",
    xaxis = xax,
    yaxis = yax
    ##############################################################################
    , annotations = list(
      x = 1,
      y = -0.1,
      text = "Source: Network Manager",
      showarrow = FALSE,
      xref = "paper",
      yref = "paper",
      xanchor = "right",
      yanchor = "auto",
      xshift = 0,
      yshift = -5,
      font = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

pbox_group
```


### Average Weekday Hourly Throughput

```{r}
thru <- params$thru %>%
  filter(
    TIME >= hm("05:55"),
    TIME <= hm("23:05")
  ) %>%
  mutate(PHASE = factor(PHASE,
    levels = c("DEP", "ARR"),
    labels = c("Departures", "Arrivals")
  ))

thru_yr <- unique(thru$YEAR)

thru_mth <- unique(thru$MONTH_NUM)

thru_tot <- thru %>%
  group_by(TIME) %>%
  summarise(ROLLING_HOUR_MVT = sum(ROLLING_HOUR_MVT, na.rm = TRUE)) %>%
  mutate(PHASE = "Total") %>%
  ungroup()

thru <- thru %>%
  bind_rows(thru_tot) %>%
  mutate(TIME = as.character(TIME), TIME = strtrim(TIME, 5))

xax <- list(
  title = "",
  type = "category",
  range = c("06:00", "23:00")
)

yax <- list(
  title = "Average Throughput [flights/hour]",
  titlefont = list(size = 11),
  hoverformat = ".2f"
)

msg <- paste0(
  "<b>Average 15-min rolling hour",
  "<br>throughput-weekdays month ",
  pick_mth[thru_mth],
  thru_yr,
  "</b>"
)

if (max(thru$ROLLING_HOUR_MVT) <= 20) {
  msg_y <- 1.2 * max(thru$ROLLING_HOUR_MVT)
} else {
  msg_y <- 0.1 * max(thru$ROLLING_HOUR_MVT)
}

thru %>%
  plot_ly(
    x = ~TIME,
    y = ~ROLLING_HOUR_MVT,
    color = ~PHASE
  ) %>%
  group_by(PHASE) %>%
  add_lines(type = "scatter") %>%
  add_annotations(
    text      = msg,
    x         = 0.5,
    xref      = "paper",
    y         = msg_y,
    showarrow = FALSE,
    ax        = 0,
    ay        = 0,
    align     = "center"
  ) %>%
  layout(
    xaxis       = xax,
    yaxis       = yax,
    hovermode   = "x unified",
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: Network Manager",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -35,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )
```


# ATFM Delay

## Row -----------------------------------------------------------
### Annual Arrival ATFM Delay


```{r atfm_pa}
if (nrow(params$atfm) > 0) {
  atfm_pa <- params$atfm %>%
    select(
      YEAR, FLT_ARR_1, DLY_APT_ARR_1, AD_DISRUPTION, AD_CAPACITY, AD_WEATHER,
      AD_DISRUPTION_ATC, AD_CAPACITY_ATC, AD_STAFFING_ATC, AD_EVENTS
    ) %>%
    group_by(YEAR) %>%
    summarise(
      FLT_ARR_TOT       = sum(FLT_ARR_1, na.rm = TRUE),
      DLY_APT_ARR_TOT   = sum(DLY_APT_ARR_1, na.rm = TRUE),
      AD_DISRUPTION     = sum(AD_DISRUPTION, na.rm = TRUE),
      AD_CAPACITY       = sum(AD_CAPACITY, na.rm = TRUE),
      AD_WEATHER        = sum(AD_WEATHER, na.rm = TRUE),
      AD_DISRUPTION_ATC = sum(AD_DISRUPTION_ATC, na.rm = TRUE),
      AD_CAPACITY_ATC   = sum(AD_CAPACITY_ATC, na.rm = TRUE),
      AD_STAFFING_ATC   = sum(AD_STAFFING_ATC, na.rm = TRUE),
      AD_EVENTS         = sum(AD_EVENTS, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    tidyr::pivot_longer(
      cols      = starts_with("AD_"),
      names_to  = "REG_REASON",
      values_to = "DLY"
    ) %>%
    mutate(
      AVG_ARR_ATFM_DLY = DLY_APT_ARR_TOT / FLT_ARR_TOT,
      AVG_ARR_ATFM_REG = DLY / FLT_ARR_TOT
    )

  # ------------------ ATFM Grouping and Colour Definition ------------------

  atfm_col <- c(
    "#595959", # rgb2hex(89,89,89)    # AD Events
    "#B9CDE5", # rgb2hex(185,205,229) # AD Disruption
    "#E6B9B8", # rgb2hex(230,185,184) # AD Capacity
    "#9BBB59", # rgb2hex(155,187,89)  # AD Weather
    "#4F81BD", # rgb2hex(79,129,189)  # AD Disruption ATC
    "#F79646", # rgb2hex(247,150,70)  # Staffing ATC
    "#C0504D" # rgb2hex(192,80,77)   # AD Capacity ATC
  )

  atfm_grps <- c(
    "AD_EVENTS",
    "AD_DISRUPTION",
    "AD_CAPACITY",
    "AD_WEATHER",
    "AD_DISRUPTION_ATC",
    "AD_STAFFING_ATC",
    "AD_CAPACITY_ATC"
  )

  atfm_lbl <- c(
    "Events",
    "Disruption",
    "Capacity",
    "Weather",
    "Disruption (ATC)",
    "Staffing (ATC)",
    "Capacity (ATC)"
  )

  # -------------------------------------------------------------------------

  atfm_pa <- atfm_pa %>%
    mutate(REG_REASON = factor(REG_REASON,
      levels = atfm_grps,
      labels = atfm_lbl
    ))

  atfm_pa %>%
    plot_ly(
      x      = ~YEAR,
      y      = ~AVG_ARR_ATFM_REG,
      color  = ~REG_REASON,
      colors = atfm_col,
      type   = "bar"
    ) %>%
    add_annotations(
      data      = atfm_pa %>% select(YEAR, AVG_ARR_ATFM_DLY) %>% unique(),
      x         = ~YEAR,
      y         = ~ AVG_ARR_ATFM_DLY + 0.03,
      text      = ~ round(AVG_ARR_ATFM_DLY, 2),
      showarrow = FALSE
    ) %>%
    layout(
      barmode   = "stack",
      hovermode = "x unified",
      xaxis     = list(title = ""),
      yaxis     = list(
        title       = "Average Arrival ATFM delay [min/arr]",
        titlefont   = list(size = 11),
        hoverformat = ".2f"
      ),
      ##############################################################################
      annotations = list(
        x         = 1,
        y         = -0.1,
        text      = "Source: Network Manager",
        showarrow = FALSE,
        xref      = "paper",
        yref      = "paper",
        xanchor   = "right",
        yanchor   = "auto",
        xshift    = 0,
        yshift    = -5,
        font      = list(size = 12)
      )
      ##############################################################################
    ) %>%
    config(
      displaylogo = FALSE,
      modeBarButtonsToRemove = config_bar_remove_buttons
    )
}
```

### Monthly Arrival ATFM Delay

```{r}
# monthly trend

if (nrow(params$atfm) > 0) {
  atfm_pm <- params$atfm %>%
    select(
      YEAR,
      MONTH_NUM,
      FLT_ARR_1,
      DLY_APT_ARR_1,
      AD_DISRUPTION,
      AD_CAPACITY,
      AD_WEATHER,
      AD_DISRUPTION_ATC,
      AD_CAPACITY_ATC,
      AD_STAFFING_ATC,
      AD_EVENTS
    ) %>%
    group_by(YEAR, MONTH_NUM) %>%
    summarise(
      FLT_ARR_TOT       = sum(FLT_ARR_1, na.rm = TRUE),
      DLY_APT_ARR_TOT   = sum(DLY_APT_ARR_1, na.rm = TRUE),
      AD_DISRUPTION     = sum(AD_DISRUPTION, na.rm = TRUE),
      AD_CAPACITY       = sum(AD_CAPACITY, na.rm = TRUE),
      AD_WEATHER        = sum(AD_WEATHER, na.rm = TRUE),
      AD_DISRUPTION_ATC = sum(AD_DISRUPTION_ATC, na.rm = TRUE),
      AD_CAPACITY_ATC   = sum(AD_CAPACITY_ATC, na.rm = TRUE),
      AD_STAFFING_ATC   = sum(AD_STAFFING_ATC, na.rm = TRUE),
      AD_EVENTS         = sum(AD_EVENTS, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    tidyr::pivot_longer(
      cols      = starts_with("AD_"),
      names_to  = "REG_REASON",
      values_to = "DLY"
    ) %>%
    mutate(
      AVG_ARR_ATFM_DLY = DLY_APT_ARR_TOT / FLT_ARR_TOT,
      AVG_ARR_ATFM_REG = DLY / FLT_ARR_TOT
    )


  filter_years <- atfm_pm %>%
    pull(YEAR) %>%
    unique()

  max_year <- max(filter_years)

  ########################## KEY MESSAGE #########################################
  
  
  MONTHLY_HIGH_ATFM <- atfm_pm %>%
    select(YEAR, MONTH_NUM, REG_REASON, AVG_ARR_ATFM_DLY, AVG_ARR_ATFM_REG) %>%
    group_by(YEAR) %>%
    filter(AVG_ARR_ATFM_DLY != 0) %>%
    filter(AVG_ARR_ATFM_REG != 0) %>%
    filter(AVG_ARR_ATFM_DLY == max(AVG_ARR_ATFM_DLY)) %>%
    filter(AVG_ARR_ATFM_REG == max(AVG_ARR_ATFM_REG)) %>% 
    arrange(YEAR) %>% 
    unique() %>% 
    mutate(
      REG_REASON = factor(REG_REASON,
      levels     = atfm_grps,
      labels     = atfm_lbl
    ))
  
  ###########################################################################
  
  annotations = vector(mode = "list", length = length(filter_years))
  for (i in 1:nrow(MONTHLY_HIGH_ATFM)) {
    annotation <- list(x = MONTHLY_HIGH_ATFM$MONTH_NUM[i],
                       y = MONTHLY_HIGH_ATFM$AVG_ARR_ATFM_DLY[i],
                       xref='x',
                       yref='y',
                       text = paste0(
                         "<b>Highest ATFM delay:<br>",
                         round(MONTHLY_HIGH_ATFM$AVG_ARR_ATFM_DLY[i], 2), " min/arr<br>(",
                         round(MONTHLY_HIGH_ATFM$AVG_ARR_ATFM_REG[i]/MONTHLY_HIGH_ATFM$AVG_ARR_ATFM_DLY[i]*100, 0),
                         "% ", MONTHLY_HIGH_ATFM$REG_REASON[i], ")</b>"),
                       yshift=40,
                       xshift = ifelse(MONTHLY_HIGH_ATFM$MONTH_NUM[i]==1,
                                       40,
                                       ifelse(MONTHLY_HIGH_ATFM$MONTH_NUM[i]==12, -40, 0)),
                       align = ifelse(MONTHLY_HIGH_ATFM$MONTH_NUM[i]==1,
                                      "left",
                                      ifelse(MONTHLY_HIGH_ATFM$MONTH_NUM[i]==12, "right", "center")),
                       showarrow = FALSE)
    annotations[[i]] <- annotation
  }
  
  source_annotation=list(x         = 1, 
                         y         = -0.1, 
                         text      = "Source: Network Manager", 
                         showarrow = F, 
                         xref      = 'paper', 
                         yref      = 'paper', 
                         xanchor   = 'right', 
                         yanchor   = 'auto', 
                         xshift    = 0, 
                         yshift    = -10,
                         font      = list(size=12))
  
  button_list=vector(mode = "list", length = length(filter_years))
  annot_list=vector(mode = "list", length = length(filter_years))
  for(x in 1:length(filter_years)){
    annot_list_temp=annot_list
    annot_list_temp[[x]]=annotations[[x]]
    if (!is.null(annotations[[x]])) {
      bl=list(
        label  = filter_years[x],
        method = "update",
        args   = list(list("transforms[0].value"=filter_years[x]),
                      list(annotations=list(annot_list_temp[[x]], source_annotation)))
      )
    } else {
      bl=list(
        label  = filter_years[x],
        method = "update",
        args   = list(list("transforms[0].value"=filter_years[x]),
                      list(annotations=list(source_annotation)))
      )
    }
    button_list[[x]]=bl
  }

  button_type_list <- list(
    type      = "buttons",
    bgcolor   = "#c3c1e8",
    active    = length(filter_years) - 1,
    direction = "right",
    xref      = "paper",
    x         = 0.3,
    xanchor   = "left",
    yref      = "paper",
    y         = 1.2,
    yanchor   = "bottom",
    buttons   = button_list
  )

  # set REG_REASON grouping and colors

  atfm_pm <- atfm_pm %>%
    mutate(
      REG_REASON = factor(REG_REASON,
      levels     = atfm_grps,
      labels     = atfm_lbl
    ))


  atfm_pm_fig <- atfm_pm %>%
    plot_ly(
      x          = ~MONTH_NUM,
      y          = ~AVG_ARR_ATFM_REG,
      customdata = ~YEAR,
      color      = ~REG_REASON,
      colors     = atfm_col,
      type       = "bar",
      transforms = list(
        list(
          type      = "filter",
          target    = "customdata",
          operation = "=",
          value     = max_year
        )
      )
    ) %>%
    add_annotations(x         = 1, 
                    y         = -0.1, 
                    text      = "Source: Network Manager", 
                    showarrow = F, 
                    xref      = 'paper', 
                    yref      = 'paper', 
                    xanchor   = 'right', 
                    yanchor   = 'auto', 
                    xshift    = 0, 
                    yshift    = -10,
                    font      = list(size=12)
    ) %>%
    layout(
      barmode   = "stack",
      hovermode = "x unified",
      xaxis     = tick_yr_no_title,
      yaxis     = list(
        title       = "Average Arrival ATFM delay [min/arr]",
        titlefont   = list(size = 11),
        hoverformat = ".2f",
        rangemode   = "tozero"
      ),
      showlegend = TRUE,
      legend = list(
        orientation = "h",
        xanchor="center",
        x = 0.5
      ),
      updatemenus = list(button_type_list)
    ) %>%
    config(
      displaylogo = FALSE,
      modeBarButtonsToRemove = config_bar_remove_buttons
    )
  if (!is.null(annotations[[length(filter_years)]])) {
    atfm_pm_fig=atfm_pm_fig %>% 
      add_annotations(x         = annotations[[length(filter_years)]]$x,
                      y         = annotations[[length(filter_years)]]$y,
                      text      = annotations[[length(filter_years)]]$text,
                      showarrow = annotations[[length(filter_years)]]$showarrow,
                      xref      = annotations[[length(filter_years)]]$xref,
                      yref      = annotations[[length(filter_years)]]$yref,
                      yshift    = annotations[[length(filter_years)]]$yshift,
                      xshift    = annotations[[length(filter_years)]]$xshift,
                      align     = annotations[[length(filter_years)]]$align
      )
  }
  
  atfm_pm_fig
  
}
```


## Row -----------------------------------------------------------

### Daily Arrival ATFM Delay

```{r}
if (nrow(params$atfm) > 0) {
  tmp <- params$atfm %>%
    group_by(FLT_DATE) %>%
    summarise(
      ARRS         = sum(FLT_ARR_1, na.rm = TRUE),
      TOT_ARR_ATFM = sum(DLY_APT_ARR_1, na.rm = TRUE),
      DLYD_ARRS    = sum(FLT_ARR_1_DLY, na.rm = TRUE),
      DLYS_ARRS_15 = sum(FLT_ARR_1_DLY_15, na.rm = TRUE)
    )

  worst_day_last_year <- tmp %>%
    top_n(365, FLT_DATE) %>%
    filter(TOT_ARR_ATFM == max(TOT_ARR_ATFM, na.rm = TRUE)) %>%
    filter(FLT_DATE == max(FLT_DATE, na.rm = TRUE))

  worst_day_date <- worst_day_last_year$FLT_DATE
  worst_day_dly <- worst_day_last_year$TOT_ARR_ATFM
  worst_day_avgATFMdly <- worst_day_last_year$TOT_ARR_ATFM / worst_day_last_year$ARRS


  if (worst_day_dly == 0) {
    key_msg <- ""
    showar  <- FALSE
  } else {
    key_msg <- paste0(
      "<b>Latest worst day in last 12 months: ", worst_day_date,
      "<br>with total Arrival ATFM delay: ", worst_day_dly, "min",
      "<br>(avg. Arrival ATFM Delay: ", round(worst_day_avgATFMdly, 2), "min)</b>"
    )
    showar  <- TRUE
  }

  p <- tmp %>%
    plot_ly(
      x       = ~FLT_DATE,
      y       = ~TOT_ARR_ATFM,
      type    = "scatter",
      mode    = "lines",
      line    = list(
        shape = "hvh",
        width = 1
      )
    ) %>%
    add_annotations(
      text      = key_msg,
      x         = worst_day_date,
      y         = worst_day_dly,
      showarrow = showar,
      ax        = -50,
      ay        = -50,
      align     = "right"
    ) %>%
    layout(
      xaxis = list(
        title = "",
        rangeslider = list(type = "date")
      ),
      yaxis = list(
        title = "Arrival ATFM delay [min]",
        titlefont = list(size = 11)
      ),
      ##############################################################################
      annotations = list(
        x         = 1,
        y         = -0.1,
        text      = "Source: Network Manager",
        showarrow = FALSE,
        xref      = "paper",
        yref      = "paper",
        xanchor   = "right",
        yanchor   = "auto",
        xshift    = 0,
        yshift    = -95,
        font      = list(size = 12)
      )
      ##############################################################################
    ) %>%
    config(
      displaylogo = FALSE,
      modeBarButtonsToRemove = config_bar_remove_buttons
    )

  p
}
```

### Share of ATFM Delay

```{r atfm-ytd}
if (nrow(params$atfm) > 0) {
  atfm_max_year <- atfm_pm %>%
    pull(YEAR) %>%
    max() %>%
    unique()

  share_atfm <- atfm_pm %>%
    filter(YEAR == atfm_max_year) %>%
    group_by(REG_REASON) %>%
    summarise(
      FLT_ARR_TOT = sum(FLT_ARR_TOT, na.rm = TRUE),
      DLY         = sum(DLY, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    mutate(
      DLY_TOT   = sum(DLY, na.rm = TRUE),
      DLY_SHARE = round(DLY / DLY_TOT, 2),
      LABELS    = paste0(REG_REASON, "<br>", DLY_SHARE, "%")
    ) %>%
    filter(DLY_SHARE > 0)

  center_text <- paste0("<b>", atfm_max_year, "</b>")

  share_atfm %>%
    plot_ly(
      labels = ~REG_REASON,
      values = ~DLY_SHARE
    ) %>%
    add_pie(
      hole         = 0.4,
      textposition = "outside"
    ) %>%
    add_annotations(
      text      = center_text,
      font      = list(size = 18),
      x         = 0.5,
      y         = 0.5,
      showarrow = FALSE
    ) %>%
    config(
      displaylogo = FALSE,
      modeBarButtonsToRemove = config_bar_remove_buttons
    )
}

```

# ATFM Slot

## Row -----------------------------------------------------------

### Annual Regulated Departures

```{r ANNUAL ATFM REG}
SLOT_YY_PLOT1 <- params$slot_yy %>%
  select(
    AIRPORT,
    YEAR,
    TOT_FLT_DEP_1,
    TOT_FLT_DEP_REG_1,
    TOT_FLT_DEP_OUT_EARLY_1,
    TOT_FLT_DEP_OUT_LATE_1,
    TOT_FLT_DEP_REG_1
  ) %>%
  mutate(
    PCT_DEP_REG = (TOT_FLT_DEP_REG_1 / TOT_FLT_DEP_1) * 100,
    PCT_DEP_OUT = ((TOT_FLT_DEP_OUT_EARLY_1 + TOT_FLT_DEP_OUT_LATE_1) / TOT_FLT_DEP_REG_1) * 100
  ) %>%
  select(YEAR, PCT_DEP_REG, PCT_DEP_OUT)


SLOT_YY_PLOT1 <- SLOT_YY_PLOT1 %>%
  mutate(YEAR = as.character(YEAR))


SLOT_YY_PLOT1 %>%
  plot_ly(
    x      = ~YEAR,
    y      = ~PCT_DEP_REG,
    type   = "bar",
    marker = list(color = "rgb(201, 201, 201)"),
    name   = "Share of ATFM<br>regulated departures"
  ) %>%
  add_markers(
    x        = ~YEAR,
    y        = ~PCT_DEP_OUT,
    name     = "Share of Outside STW",
    marker   = list(
      symbol = "square",
      color  = "rgb(192, 0, 0)",
      size   = 10
    )
  ) %>%
  layout(
    hovermode = "x unified",
    xaxis     = list(title = ""),
    yaxis     = list(
      title       = "Percentage of departures",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    ),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: Network Manager",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -5,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )


```

### Monthly Regulated Departures
```{r MONTHLY ATFM REG}
SLOT_MM_PLOT1 <- params$slot_mm %>%
  select(
    AIRPORT,
    YEAR,
    MONTH_NUM,
    TOT_FLT_DEP_1,
    TOT_FLT_DEP_REG_1,
    TOT_FLT_DEP_OUT_EARLY_1,
    TOT_FLT_DEP_OUT_LATE_1,
    TOT_FLT_DEP_REG_1
  ) %>%
  mutate(
    PCT_DEP_REG = (TOT_FLT_DEP_REG_1 / TOT_FLT_DEP_1) * 100,
    PCT_DEP_OUT = ((TOT_FLT_DEP_OUT_EARLY_1 + TOT_FLT_DEP_OUT_LATE_1) / TOT_FLT_DEP_REG_1) * 100
  ) %>%
  select(YEAR, MONTH_NUM, PCT_DEP_REG, PCT_DEP_OUT)
# %>%
#                  tidyr::pivot_longer(cols  = c(PCT_DEP_REG ,PCT_DEP_OUT),
#                                      names_to  = "PCT_CAT",
#                                      values_to = "PCT_VAL")

# pct_col <- c("#c9c9c9","#C00000")

# SLOT_YY_PLOT1$PCT_CAT <- factor(SLOT_YY_PLOT1$PCT_CAT,
#                           levels=c( "PCT_DEP_REG","PCT_DEP_OUT"),
#                           labels=c( "Share of ATFM<br>regulated departures","Share of Outside STW"))

filter_years <- SLOT_YY_PLOT1 %>%
  pull(YEAR) %>%
  unique()

max_year <- max(filter_years)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)

# SLOT_YY_PLOT1 %>%
#  plot_ly(x          = ~MONTH_NUM,
#          y          = ~PCT_VAL,
#          customdata = ~YEAR,
#          color      = ~PCT_CAT,
#          colors     = pct_col,
#          type       = "bar",
#          transforms = list(list(type      = 'filter',
#                                 target    = "customdata",
#                                 operation = '=',
#                                 value     = max_year)
#                           )
#         ) %>%
#  layout( barmode     = "group",
#          hovermode   = "x unified",
#          xaxis       = tick_yr_no_title,
#          yaxis       = list( title="Percentage of departures",
#                              titlefont = list(size = 11),
#                              hoverformat = ".2f"),
#          showlegend  = TRUE,
#          updatemenus = list( button_type_list )
#         ) %>%
#  config( displaylogo = FALSE,
#        modeBarButtonsToRemove = config_bar_remove_buttons)

SLOT_MM_PLOT1 %>%
  plot_ly(
    x          = ~MONTH_NUM,
    y          = ~PCT_DEP_REG,
    customdata = ~YEAR,
    type       = "bar",
    marker     = list(color = "rgb(201, 201, 201)"),
    name       = "Share of ATFM<br>regulated departures",
    transforms = list(
      list(
        type      = "filter",
        target    = "customdata",
        operation = "=",
        value     = max_year
      )
    )
  ) %>%
  add_markers(
    x        = ~MONTH_NUM,
    y        = ~PCT_DEP_OUT,
    name     = "Share of Outside STW",
    marker   = list(
      symbol = "square",
      color  = "rgb(192, 0, 0)",
      size   = 10
    )
  ) %>%
  layout(
    hovermode = "x unified",
    xaxis = tick_yr_no_title,
    yaxis = list(
      title = "Percentage of departures",
      titlefont = list(size = 11),
      hoverformat = ".2f"
    ),
    showlegend = TRUE,
    updatemenus = list(button_type_list),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: Network Manager",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -10,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )


```

## Row -----------------------------------------------------------

### Annual ATFM Slot Adherence

```{r ANNUAL ATFM SLOT2}
SLOT_YY_PLOT2 <- params$slot_yy %>%
  select(YEAR, TOT_FLT_DEP_OUT_LATE_1, TOT_FLT_DEP_OUT_EARLY_1, TOT_FLT_DEP_IN_1) %>%
  tidyr::pivot_longer(
    cols = c(TOT_FLT_DEP_OUT_LATE_1, TOT_FLT_DEP_OUT_EARLY_1, TOT_FLT_DEP_IN_1),
    names_to  = "SLOT_CAT",
    values_to = "NB_SLOT"
  )

slot_col <- c(
  "#BDD7EE", # blue
  "#C6E0B4", # green
  "#F8CBAD"
) # orange

SLOT_YY_PLOT2$SLOT_CAT <- factor(SLOT_YY_PLOT2$SLOT_CAT,
  levels = c(
    "TOT_FLT_DEP_OUT_EARLY_1",
    "TOT_FLT_DEP_IN_1",
    "TOT_FLT_DEP_OUT_LATE_1"
  ),
  labels = c(
    "Before the STW<br>(Early Take-Off Traffic)",
    "Within the STW<br>[-5 minutes, +10 minutes]",
    "After the STW<br>(Late Take-Off Traffic)"
  )
)

SLOT_YY_PLOT2 <- SLOT_YY_PLOT2 %>%
  mutate(YEAR = as.character(YEAR))

SLOT_YY_PLOT2 %>%
  plot_ly(
    x             = ~YEAR,
    y             = ~NB_SLOT,
    type          = "bar",
    color         = ~SLOT_CAT,
    colors        = slot_col,
    hovertemplate = "%{y:.r}"
  ) %>%
  layout(
    barmode   = "stack",
    hovermode = "x unified",
    xaxis     = list(title = ""),
    yaxis     = list(
      title     = "Number of Regulated departures",
      titlefont = list(size = 11)
    ),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: Network Manager",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -5,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )


```

### Monthly ATFM Slot Adherence

```{r MONTHLY ATFM SLOT2}
SLOT_MM_PLOT2 <- params$slot_mm %>%
  select(YEAR,
         MONTH_NUM,
         TOT_FLT_DEP_OUT_LATE_1,
         TOT_FLT_DEP_OUT_EARLY_1,
         TOT_FLT_DEP_IN_1) %>%
  tidyr::pivot_longer(
    cols = c(TOT_FLT_DEP_OUT_LATE_1, TOT_FLT_DEP_OUT_EARLY_1, TOT_FLT_DEP_IN_1),
    names_to = "SLOT_CAT",
    values_to = "NB_SLOT"
  )

slot_col <- c(
  "#BDD7EE", # blue
  "#C6E0B4", # green
  "#F8CBAD"
) # orange

SLOT_MM_PLOT2$SLOT_CAT <- factor(SLOT_MM_PLOT2$SLOT_CAT,
  levels = c(
    "TOT_FLT_DEP_OUT_EARLY_1",
    "TOT_FLT_DEP_IN_1",
    "TOT_FLT_DEP_OUT_LATE_1"
  ),
  labels = c(
    "Before the STW<br>(Early Take-Off Traffic)",
    "Within the STW<br>[-5 minutes, +10 minutes]",
    "After the STW<br>(Late Take-Off Traffic)"
  )
)

filter_years <- SLOT_MM_PLOT2 %>%
  pull(YEAR) %>%
  unique()

max_year <- max(filter_years)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)

SLOT_MM_PLOT2 %>%
  plot_ly(
    x             = ~MONTH_NUM,
    y             = ~NB_SLOT,
    customdata    = ~YEAR,
    color         = ~SLOT_CAT,
    colors        = slot_col,
    hovertemplate = "%{y:.r}",
    type          = "bar",
    transforms    = list(
      list(
        type        = "filter",
        target      = "customdata",
        operation   = "=",
        value       = max_year
      )
    )
  ) %>%
  layout(
    barmode   = "stack",
    hovermode = "x unified",
    xaxis     = tick_yr_no_title,
    yaxis     = list(
      title     = "Number of Regulated departures",
      titlefont = list(size = 11)
    ),
    showlegend = TRUE,
    updatemenus = list(button_type_list),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: Network Manager",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -10,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )
```

# CDO/CCO

```{r cdo-cco-data-check, results='asis', eval=nrow(params$cdo_cco)==0}

cat("Analyses on vertical flight efficiency during climb and descent for ", params$icao, " are not available. Please contact pru-support@eurocontrol.int for further information.")
  
```

  
```{r cdo-cco-row1, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r cdo-cco-title1, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

cat("### Average time flown level per flight")

```

  
```{r Avg-time-lvl, eval=nrow(params$cdo_cco)>0, echo = FALSE}

AVG_TIME_LVL_PLOT <- params$cdo_cco %>%
  select(YEAR, MONTH_NUM, AVG_TIME_LVL_DESCENT, AVG_TIME_LVL_CLIMB)

filter_years <- AVG_TIME_LVL_PLOT %>%
  pull(YEAR) %>%
  unique()

max_year <- max(filter_years)

AVG_TIME_LVL_min=group_by(AVG_TIME_LVL_PLOT, YEAR) %>% 
  filter(AVG_TIME_LVL_DESCENT==min(AVG_TIME_LVL_DESCENT)) %>% 
  arrange(YEAR)

annotations = vector(mode = "list", length = length(filter_years))
for (i in 1:nrow(AVG_TIME_LVL_min)) {
  annotation <- list(x = AVG_TIME_LVL_min$MONTH_NUM[i],
                     y = AVG_TIME_LVL_min$AVG_TIME_LVL_DESCENT[i]/60,
                     xref='x',
                     yref='y',
                     text = paste0(
                       "<b>Lowest value<br>(descent):<br>",
                       round(AVG_TIME_LVL_min$AVG_TIME_LVL_DESCENT[i]/60, 1), " min.</b>"),
                     yshift=40,
                     xshift = ifelse(AVG_TIME_LVL_min$MONTH_NUM[i]==1,
                                     20,
                                     ifelse(AVG_TIME_LVL_min$MONTH_NUM[i]==12, -20, 0)),
                     align = ifelse(AVG_TIME_LVL_min$MONTH_NUM[i]==1,
                                    "left",
                                    ifelse(AVG_TIME_LVL_min$MONTH_NUM[i]==12, "right", "center")),
                     showarrow = FALSE)
  annotations[[i]] <- annotation
}

source_annotation=list(x         = 1, 
                       y         = -0.1, 
                       text      = "Source: AIU analysis", 
                       showarrow = F, 
                       xref      = 'paper', 
                       yref      = 'paper', 
                       xanchor   = 'right', 
                       yanchor   = 'auto', 
                       xshift    = 0, 
                       yshift    = -10,
                       font      = list(size=12))

button_list=vector(mode = "list", length = length(filter_years))
annot_list=vector(mode = "list", length = length(filter_years))
for(x in 1:length(filter_years)){
  annot_list_temp=annot_list
  annot_list_temp[[x]]=annotations[[x]]
  if (!is.null(annotations[[x]])) {
      bl=list(
        label  = filter_years[x],
        method = "update",
        args   = list(list("transforms[0].value"=filter_years[x]),
                      list(annotations=list(annot_list_temp[[x]], source_annotation)))
      )
  } else {
      bl=list(
        label  = filter_years[x],
        method = "update",
        args   = list(list("transforms[0].value"=filter_years[x]),
                      list(annotations=list(source_annotation)))
      )
    }
    button_list[[x]]=bl
}
   
button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)


# AVG_TIME_LVL_PLOT=mutate(AVG_TIME_LVL_PLOT, YEAR = as.character(YEAR))

avg_time_lvl_fig=plot_ly(AVG_TIME_LVL_PLOT, 
        x = ~MONTH_NUM, 
        y = ~AVG_TIME_LVL_DESCENT/60, 
        customdata = ~YEAR, 
        marker = list(color = 'rgb(40, 120, 181)'),
        hovertemplate = "%{y:.1f}",
        type = 'bar', 
        name = 'Descent',
        transforms = list(list(type      = 'filter',
                               target    = "customdata",
                               operation = '=',
                               value     = max_year)
        )) %>% 
  add_trace(y = ~AVG_TIME_LVL_CLIMB/60, 
            marker = list(color = 'rgb(106, 168, 82)'),
            name = 'Climb') %>%
  add_annotations(x         = 1, 
                  y         = -0.1, 
                  text      = "Source: AIU analysis", 
                  showarrow = F, 
                  xref      = 'paper', 
                  yref      = 'paper', 
                  xanchor   = 'right', 
                  yanchor   = 'auto', 
                  xshift    = 0, 
                  yshift    = -10,
                  font      = list(size=12)
  ) %>%
  layout(barmode = 'group',
         hovermode   = "x unified",
         xaxis       = tick_yr_no_title,
         yaxis       = list( title="Average time flown level per flight (min.)",
                             titlefont = list(size = 11)),
         showlegend  = TRUE,
         updatemenus = list( button_type_list )
         
  ) %>% 
  config( displaylogo = FALSE,
          modeBarButtonsToRemove = config_bar_remove_buttons)

if (!is.null(annotations[[length(filter_years)]])) {
    avg_time_lvl_fig=avg_time_lvl_fig %>% 
      add_annotations(x         = annotations[[length(filter_years)]]$x,
                      y         = annotations[[length(filter_years)]]$y,
                      text      = annotations[[length(filter_years)]]$text,
                      showarrow = annotations[[length(filter_years)]]$showarrow,
                      xref      = annotations[[length(filter_years)]]$xref,
                      yref      = annotations[[length(filter_years)]]$yref,
                      yshift    = annotations[[length(filter_years)]]$yshift,
                      xshift    = annotations[[length(filter_years)]]$xshift,
                      align     = annotations[[length(filter_years)]]$align
      )
}

avg_time_lvl_fig

```


```{r cdo-cco-title2, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

cat("### Median CDO/CCO altitudes")

```


```{r Med-CDO-CCO-alt, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

MED_CDO_CCO_ALT_PLOT <- params$cdo_cco %>% 
  select(YEAR, MONTH_NUM, MEDIAN_CDO_ALT, MEDIAN_CCO_ALT)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)

plot_ly(MED_CDO_CCO_ALT_PLOT, 
        x = ~MONTH_NUM, 
        y = ~MEDIAN_CDO_ALT, 
        customdata = ~YEAR, 
        marker = list(color = 'rgb(40, 120, 181)'),
        hovertemplate = "%{y:.0f}",
        type = 'bar', 
        name = 'Descent',
        transforms = list(list(type      = 'filter',
                               target    = "customdata",
                               operation = '=',
                               value     = max_year)
        )) %>% 
  add_trace(y = ~MEDIAN_CCO_ALT, 
            marker = list(color = 'rgb(106, 168, 82)'),
            name = 'Climb') %>%
  layout(barmode = 'group',
         hovermode   = "x unified",
         xaxis       = tick_yr_no_title,
         yaxis       = list( title="Median CDO/CCO altitude (feet)",
                             titlefont = list(size = 11)),
         showlegend  = TRUE,
         updatemenus = list( button_type_list )
         ##############################################################################
         ,annotations = list(
           x         = 1, 
           y         = -0.1, 
           text      = "Source: AIU analysis", 
           showarrow = F, 
           xref      = 'paper', 
           yref      = 'paper', 
           xanchor   = 'right', 
           yanchor   = 'auto', 
           xshift    = 0, 
           yshift    = -10,
           font      =list(size=12)
         )          
         ##############################################################################
  ) %>% 
  config( displaylogo = FALSE,
          modeBarButtonsToRemove = config_bar_remove_buttons)

```


```{r cdo-cco-row2, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r cdo-cco-title3, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

cat("### Share of CDO/CCO flights")

```


```{r Share-unimpeded, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

SHARE_CDO_CCO_FLIGHTS_PLOT <- params$cdo_cco %>% 
    select(YEAR, MONTH_NUM, SHARE_CDO_FLIGHTS, SHARE_CCO_FLIGHTS)
  
button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)

plot_ly(SHARE_CDO_CCO_FLIGHTS_PLOT, 
        x = ~MONTH_NUM, 
        y = ~SHARE_CDO_FLIGHTS*100, 
        customdata = ~YEAR, 
        marker = list(color = 'rgb(40, 120, 181)'),
        hovertemplate = "%{y:.1f}%",
        type = 'bar', 
        name = 'Descent',
        transforms = list(list(type      = 'filter',
                               target    = "customdata",
                               operation = '=',
                               value     = max_year)
        )) %>% 
  add_trace(y = ~SHARE_CCO_FLIGHTS*100, 
            marker = list(color = 'rgb(106, 168, 82)'),
            name = 'Climb') %>%
  layout(barmode = 'group',
         hovermode   = "x unified",
         xaxis       = tick_yr_no_title,
         yaxis       = list( title="Share of CDO/CCO flights (%)",
                             titlefont = list(size = 11),
                             ticksuffix = "%",  
                             range = c(0, 100)),
         showlegend  = TRUE,
         updatemenus = list( button_type_list )
         ##############################################################################
         ,annotations = list(
           x         = 1, 
           y         = -0.1, 
           text      = "Source: AIU analysis", 
           showarrow = F, 
           xref      = 'paper', 
           yref      = 'paper', 
           xanchor   = 'right', 
           yanchor   = 'auto', 
           xshift    = 0, 
           yshift    = -10,
           font      =list(size=12)
         )          
         ##############################################################################
  ) %>% 
  config( displaylogo = FALSE,
          modeBarButtonsToRemove = config_bar_remove_buttons)

```



```{r cdo-cco-title4, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

cat("### Median CDO/CCO altitudes vs. Average time flown level per flight")

```


```{r Med-CDO-CCO-alt-avg-time-lvl, results='asis', eval=nrow(params$cdo_cco)>0, echo = FALSE}

MED_CDO_CCO_ALT_AVG_TIME_LVL_PLOT <- params$cdo_cco %>% 
    select(YEAR, MONTH_NUM, AVG_TIME_LVL_DESCENT, AVG_TIME_LVL_CLIMB, MEDIAN_CDO_ALT, MEDIAN_CCO_ALT) %>% 
    mutate(Date=as.factor(as.POSIXct(paste0(YEAR, "-", MONTH_NUM, "-01"), "%d/%m/%Y")))
  
plot_ly(MED_CDO_CCO_ALT_AVG_TIME_LVL_PLOT,
        x = ~AVG_TIME_LVL_DESCENT/60,
        y = ~MEDIAN_CDO_ALT,
        marker = list(color = 'rgb(40, 120, 181)'),
        hovertemplate = "%{x:.1f} min/flight <br>%{y:.0f} feet",
        frame = ~Date,
        name = 'Descent',
        type = 'scatter',
        mode = 'markers',
        showlegend = T
) %>% 
  add_trace(x = ~AVG_TIME_LVL_CLIMB/60, 
            y = ~MEDIAN_CCO_ALT,
            marker = list(color = 'rgb(106, 168, 82)'),
            name = 'Climb') %>%
  layout(xaxis       = list( title="Average time flown level per flight (min.)",
                             titlefont = list(size = 11),
                             range = c(0, max(max(MED_CDO_CCO_ALT_AVG_TIME_LVL_PLOT$AVG_TIME_LVL_DESCENT),
                                              max(MED_CDO_CCO_ALT_AVG_TIME_LVL_PLOT$AVG_TIME_LVL_CLIMB)))/60),
         yaxis       = list( title="Median CDO/CCO altitude (feet)",
                             titlefont = list(size = 11),
                             range = c(0, max(max(MED_CDO_CCO_ALT_AVG_TIME_LVL_PLOT$MEDIAN_CDO_ALT),
                                              max(MED_CDO_CCO_ALT_AVG_TIME_LVL_PLOT$MEDIAN_CCO_ALT)))),
         showlegend  = TRUE
         ##############################################################################
         ,annotations = list(
           x         = 1, 
           y         = -0.1, 
           text      = "Source: AIU analysis", 
           showarrow = F, 
           xref      = 'paper', 
           yref      = 'paper', 
           xanchor   = 'right', 
           yanchor   = 'auto', 
           xshift    = 0, 
           yshift    = -10,
           font      =list(size=12)
         )          
         ##############################################################################
  ) %>% 
  config( displaylogo = FALSE,
          modeBarButtonsToRemove = config_bar_remove_buttons)

```

<!--
# Punctuality

```{r punctuality-data-check, results='asis', eval=params$apdf != "Y"}

cat("
Analyses on punctuality are only available for airports providing the required data 
using the Airport Operator Data Flow (APDF).

If you belong to the airport and would like to implement such data flow, please contact DANSAP@eurocontrol.int")
  
```

  
```{r punctuality-row1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r punctuality-title1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual Departure Punctuality")

```

  
```{r Punctuality DEP YEARLY LAYOUT, results='asis', eval=params$apdf == "Y", echo = FALSE}

pun_col <- c(
  "#1f4e79", # EARLY >30		#rgb 31,78,121
  "#8497b0", # EARLY 16-30	#rgb 132,151,176
  "#c5e0b4", # EARLY 5-15	  #rgb 197,224,180
  "#70ad47", # ON TIME -+4	#rgb 112,173,71
  "#ffe699", # LATE 5-15		#rgb 255,230,153
  "#e1c000", # LATE 16-30	  #rgb 225,192,0
  "#ff0000", # LATE 31-60	  #rgb 255,0,0
  "#c00000"
) # LATE >60		  #rgb 192,0,0

punc_dep_yy_plot <- params$punc_dep_yy

punc_dep_yy_plot$PUNCT_CAT <- factor(punc_dep_yy_plot$PUNCT_CAT,
                                     levels = c(
                                       "Early >30",
                                       "Early 16-30",
                                       "Early 5-15",
                                       "On Time -+4",
                                       "Late 5-15",
                                       "Late 16-30",
                                       "Late 31-60",
                                       "Late >60"
                                     )
)

punc_dep_yy_plot %>%
  plot_ly(
    x      = ~YEAR,
    y      = ~AVG_PER_CATEG,
    type   = "bar",
    color  = ~PUNCT_CAT,
    colors = pun_col
  ) %>%
  layout(
    barmode = "stack",
    hovermode = "x unified",
    xaxis = list(title = ""),
    yaxis = list(
      title = "Departure Punctuality repartition (%)",
      titlefont = list(size = 11),
      hoverformat = ".2f"
    ),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: APDF",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -5,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```


```{r punctuality-title2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly Departure Punctuality")

```


```{r Punctuality DEP MONHTLY LAYOUT, results='asis', eval=params$apdf == "Y", echo = FALSE}

punc_dep_mm_plot <- params$punc_dep_mm

punc_dep_mm_plot$PUNCT_CAT <- factor(
  punc_dep_mm_plot$PUNCT_CAT,
  levels = c(
    "Early >30",
    "Early 16-30",
    "Early 5-15",
    "On Time -+4",
    "Late 5-15",
    "Late 16-30",
    "Late 31-60",
    "Late >60"))


filter_years <- punc_dep_mm_plot %>%
  pull(YEAR) %>%
  unique()

max_year <- max(filter_years)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)

punc_dep_mm_plot %>%
  plot_ly(
    x          = ~MONTH_NUM,
    y          = ~AVG_PER_CATEG,
    customdata = ~YEAR,
    color      = ~PUNCT_CAT,
    colors     = pun_col,
    type       = "bar",
    transforms = list(
      list(
        type      = "filter",
        target    = "customdata",
        operation = "=",
        value     = max_year
      )
    )
  ) %>%
  layout(
    barmode   = "stack",
    hovermode = "x unified",
    xaxis     = tick_yr_no_title,
    yaxis     = list(
      title       = "Departure Punctuality repartition (%)",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    ),
    showlegend = TRUE,
    updatemenus = list(button_type_list),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: APDF",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -10,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```


```{r punctuality-row2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r punctuality-title3, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual Arrival Punctuality")

```


```{r Punctuality ARR YEARLY LAYOUT, results='asis', eval=params$apdf == "Y", echo = FALSE}

punc_arr_yy_plot <- params$punc_arr_yy

punc_arr_yy_plot$PUNCT_CAT <- factor(
  punc_arr_yy_plot$PUNCT_CAT,
  levels = c(
    "Early >30",
    "Early 16-30",
    "Early 5-15",
    "On Time -+4",
    "Late 5-15",
    "Late 16-30",
    "Late 31-60",
    "Late >60"
  )
)


punc_arr_yy_plot %>%
  plot_ly(
    x      = ~YEAR,
    y      = ~AVG_PER_CATEG,
    color  = ~PUNCT_CAT,
    colors = pun_col,
    type   = "bar"
  ) %>%
  layout(
    barmode   = "stack",
    hovermode = "x unified",
    xaxis     = list(title = ""),
    yaxis     = list(
      title       = "Arrival Punctuality repartition (%)",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    ),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: APDF",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -5,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```


```{r punctuality-title4, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly Arrival Punctuality")

```


```{r Punctuality ARR MONHTLY LAYOUT, results='asis', eval=params$apdf == "Y", echo = FALSE}

punc_arr_mm_plot <- params$punc_arr_mm

punc_arr_mm_plot$PUNCT_CAT <- factor(punc_arr_mm_plot$PUNCT_CAT,
                                     levels = c(
                                       "Early >30",
                                       "Early 16-30",
                                       "Early 5-15",
                                       "On Time -+4",
                                       "Late 5-15",
                                       "Late 16-30",
                                       "Late 31-60",
                                       "Late >60"
                                     )
)


filter_years <- punc_arr_mm_plot %>%
  pull(YEAR) %>%
  unique()

max_year <- max(filter_years)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)

punc_arr_mm_plot %>%
  plot_ly(
    x          = ~MONTH_NUM,
    y          = ~AVG_PER_CATEG,
    color      = ~PUNCT_CAT,
    colors     = pun_col,
    type       = "bar",
    customdata = ~YEAR,
    transforms = list(
      list(
        type      = "filter",
        target    = "customdata",
        operation = "=",
        value     = max_year
      )
    )
  ) %>%
  layout(
    barmode   = "stack",
    hovermode = "x unified",
    xaxis     = tick_yr_no_title,
    yaxis     = list(
      title       = "Arrival Punctuality repartition (%)",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    ),
    showlegend = TRUE,
    updatemenus = list(button_type_list),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: APDF",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -10,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```
-->

# ASMA Time

```{r ASMA-time-data-check, results='asis', eval=params$apdf != "Y"}

cat("<center> 
Analyses on approach times are only available for airports providing the required data 
using the Airport Operator Data Flow (APDF).

If you belong to the airport and would like to implement such data flow, please contact DANSAP@eurocontrol.int </center>")
  
```

  
```{r ASMA-time-row1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r ASMA-time-title1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual ASMA Time")

```


```{r ASMA YEARLY LAYOUT, results='asis', eval=params$apdf == "Y", echo = FALSE}

ASMA_YY <- params$asma_yy %>%
  tidyr::pivot_longer(
    cols = c("AVG_UNIMP_TIME", "AVG_ADD_TIME"),
    names_to = "TYPE",
    values_to = "TIME"
  )

ASMA_YY <- ASMA_YY %>%
  mutate(TYPE = factor(TYPE,
                       levels = c("AVG_UNIMP_TIME", "AVG_ADD_TIME"),
                       labels = c("Avg. Reference time", "Avg. Additional time")
  ))
ASMA_YY <- ASMA_YY %>%
  mutate(YEAR = as.character(YEAR))

########################## KEY MESSAGE #########################################

ASMA_VAR <- params$asma_mm %>%
  filter(AVG_ADD_TIME != "NaN") %>%
  select(YEAR, TOT_FLT, TOT_ADD_TIME) %>%
  group_by(YEAR) %>%
  summarise(
    TOT_ADD_TIME = sum(TOT_ADD_TIME, na.rm = TRUE),
    TOT_FLT = sum(TOT_FLT, na.rm = TRUE)
  ) %>%
  ungroup()

CUM_ASMA <- params$asma_mm %>%
  filter(AVG_ADD_TIME != "NaN") %>%
  select(YEAR, MONTH_NUM, TOT_ADD_TIME, TOT_FLT) %>%
  mutate(across(c(YEAR, MONTH_NUM), as.numeric)) %>%
  filter(YEAR %in% c(max(YEAR), max(YEAR) - 1))

YEAR_MAX_MONTH <- CUM_ASMA %>%
  filter(YEAR == max(YEAR)) %>%
  pull(MONTH_NUM) %>%
  max() %>%
  unique()

CUM_ASMA <- CUM_ASMA %>%
  filter(MONTH_NUM <= YEAR_MAX_MONTH) %>%
  group_by(YEAR) %>%
  summarise(TOT_ASMA = sum(TOT_ADD_TIME, na.rm = TRUE) / sum(TOT_FLT, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(CHANGE = (TOT_ASMA - lag(TOT_ASMA)) / lag(TOT_ASMA))

msg_tmpl <- "<b>Add.Change Jan-{mnt}<br>{yr2} vs {yr1}:<br>{pct}% </b>"

msg <- str_glue(msg_tmpl,
                mnt = pick_mth[YEAR_MAX_MONTH],
                yr1 = CUM_ASMA$YEAR[1],
                yr2 = CUM_ASMA$YEAR[2],
                pct = round(100 * CUM_ASMA[2, "CHANGE"], 2)
)

ALL_YEAR <- ASMA_YY %>%
  filter(TIME != "NaN") %>%
  pull(YEAR) %>%
  unique()

msg_y <- params$asma_yy %>%
  filter(AVG_ADD_TIME != "NaN") %>%
  filter(YEAR == as.integer(max(YEAR)) - 1) %>%
  mutate(TOT_ASMA = 1.1 * (AVG_UNIMP_TIME + AVG_ADD_TIME)) %>%
  pull(TOT_ASMA)

key_msg <- list(
  x = length(ALL_YEAR) - 1,
  y = msg_y,
  text = msg,
  size = 14,
  showarrow = FALSE
)

###########################################################################


ASMA_YY %>%
  plotly::plot_ly(
    x          = ~YEAR,
    y          = ~TIME,
    type       = "bar",
    showlegend = TRUE,
    color      = ~TYPE
  ) %>%
  layout(
    barmode   = "stack",
    hovermode = "x unified",
    xaxis     = list(title = ""),
    yaxis     = list(
      title       = "Average ASMA time [min/arr]",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    ),
    annotations = key_msg
  ) %>%
  add_annotations(x         = 1, 
                  y         = -0.1, 
                  text      = "Source: APDF", 
                  showarrow = F, 
                  xref      = 'paper', 
                  yref      = 'paper', 
                  xanchor   = 'right', 
                  yanchor   = 'auto', 
                  xshift    = 0, 
                  yshift    = -10,
                  font      = list(size=12)
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```

  
```{r ASMA-time-title2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly ASMA Time")

```


```{r ASMA MONTHLY LAYOUT, results='asis', eval=params$apdf == "Y", echo = FALSE}

ASMA_MM <- params$asma_mm %>%
  tidyr::pivot_longer(
    cols      = c("AVG_UNIMP_TIME", "AVG_ADD_TIME"),
    names_to  = "TYPE",
    values_to = "TIME"
  )

ASMA_MM <- ASMA_MM %>%
  mutate(
    TYPE   = factor(TYPE,
                    levels = c("AVG_UNIMP_TIME", "AVG_ADD_TIME"),
                    labels = c("Avg. Reference time", "Avg. Additional time")
    ))

filter_years <- ASMA_MM %>%
  pull(YEAR) %>%
  unique()

max_year <- max(filter_years)

MONTHLY_HIGH_ASMA = ASMA_MM %>% 
  filter(TYPE=="Avg. Additional time") %>% 
  mutate(AVG_TIME=(TOT_UNIMP_TIME + TOT_ADD_TIME)/TOT_FLT) %>% 
  select(YEAR, MONTH_NUM, TIME, AVG_TIME) %>% 
  group_by(YEAR) %>% 
  filter(TIME !=0) %>% 
  filter(TIME==max(TIME)) %>% 
  arrange(YEAR)

annotations = vector(mode = "list", length = length(filter_years))
for (i in 1:nrow(MONTHLY_HIGH_ASMA)) {
  annotation <- list(x = MONTHLY_HIGH_ASMA$MONTH_NUM[i],
                     y = MONTHLY_HIGH_ASMA$AVG_TIME[i],
                     xref='x',
                     yref='y',
                     text = paste0(
                       "<b>Highest average<br>additional ASMA time:<br>",
                       round(MONTHLY_HIGH_ASMA$TIME[i], 2), " min/arr</b>"),
                     yshift=40,
                     xshift = ifelse(MONTHLY_HIGH_ASMA$MONTH_NUM[i]==1,
                                    45,
                                    ifelse(MONTHLY_HIGH_ASMA$MONTH_NUM[i]==12, -45, 0)),
                     align = ifelse(MONTHLY_HIGH_ASMA$MONTH_NUM[i]==1,
                                    "left",
                                    ifelse(MONTHLY_HIGH_ASMA$MONTH_NUM[i]==12, "right", "center")),
                     showarrow = FALSE)
  annotations[[i]] <- annotation
}

source_annotation=list(x         = 1, 
                       y         = -0.1, 
                       text      = "Source: APDF", 
                       showarrow = F, 
                       xref      = 'paper', 
                       yref      = 'paper', 
                       xanchor   = 'right', 
                       yanchor   = 'auto', 
                       xshift    = 0, 
                       yshift    = -10,
                       font      = list(size=12))

button_list=vector(mode = "list", length = length(filter_years))
annot_list=vector(mode = "list", length = length(filter_years))
for(x in 1:length(filter_years)){
  annot_list_temp=annot_list
  annot_list_temp[[x]]=annotations[[x]]
  if (!is.null(annotations[[x]])) {
    bl=list(
      label  = filter_years[x],
      method = "update",
      args   = list(list("transforms[0].value"=filter_years[x]),
                    list(annotations=list(annot_list_temp[[x]], source_annotation)))
    )
  } else {
    bl=list(
      label  = filter_years[x],
      method = "update",
      args   = list(list("transforms[0].value"=filter_years[x]),
                    list(annotations=list(source_annotation)))
    )
  }
  button_list[[x]]=bl
}

button_type_list <- list(
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom",
  buttons   = button_list
)

asma_mm_fig = ASMA_MM %>%
  plot_ly(
    x          = ~MONTH_NUM,
    y          = ~TIME,
    customdata = ~YEAR,
    color      = ~TYPE,
    type       = "bar",
    transforms = list(
      list(
        type      = "filter",
        target    = "customdata",
        operation = "=",
        value     = max_year
      )
    )
  ) %>%
  add_annotations(x         = 1, 
                  y         = -0.1, 
                  text      = "Source: APDF", 
                  showarrow = F, 
                  xref      = 'paper', 
                  yref      = 'paper', 
                  xanchor   = 'right', 
                  yanchor   = 'auto', 
                  xshift    = 0, 
                  yshift    = -10,
                  font      = list(size=12)
  ) %>%
  layout(
    barmode   = "stack",
    hovermode = "x unified",
    xaxis     = tick_yr_no_title,
    yaxis     = list(
      title       = "Average ASMA time [min/arr]",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    ),
    showlegend = TRUE,
    legend = list(
      orientation = "h",
      xanchor="center",
      x = 0.5
    ),
    updatemenus = list(button_type_list)
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )
if (!is.null(annotations[[length(filter_years)]])) {
    asma_mm_fig=asma_mm_fig %>% 
      add_annotations(x         = annotations[[length(filter_years)]]$x,
                      y         = annotations[[length(filter_years)]]$y,
                      text      = annotations[[length(filter_years)]]$text,
                      showarrow = annotations[[length(filter_years)]]$showarrow,
                      xref      = annotations[[length(filter_years)]]$xref,
                      yref      = annotations[[length(filter_years)]]$yref,
                      yshift    = annotations[[length(filter_years)]]$yshift,
                      xshift    = annotations[[length(filter_years)]]$xshift,
                      align     = annotations[[length(filter_years)]]$align
      )
  }
  
asma_mm_fig

```

  
```{r ASMA-time-row2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```


<!-- 


```{r ASMA-time-title3, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly ASMA Trend (current Year)")

```


```{r ASMA TREND LAYOUT, results='asis', eval=params$apdf == "Y", echo = FALSE}

TMP <- params$asma_mm %>% 
mutate( DATE_YM = paste0(YEAR,"-",MONTH_NUM),
DATE_YM = lubridate::parse_date_time(DATE_YM, "ym"))

TMP %>% 
plot_ly(x    = ~DATE_YM, 
y    = ~AVG_ADD_TIME, 
type = 'scatter',
mode = 'lines', 
line = list(shape = "hvh", 
width = 1)) %>%
layout( hoverformat = ".2f",
xaxis = list(title = "", 
rangeselector = list(buttons = list(list(count = 3,
label = "3 mo",
step = "month",
stepmode = "backward"),
list(count = 6,
label = "6 mo",
step = "month",
stepmode = "backward"),
list(count = 1,
label = "1 yr",
step = "year",
stepmode = "backward"),
list(count = 1,
label = "YTD",
step = "year",
stepmode = "todate"),
list(step = "all"))),
rangeslider = list(type = "date")), 
yaxis = list(title = "Additional Average ASMA time [min/arr]",
titlefont = list(size = 11))) %>% 
config( displaylogo = FALSE,
modeBarButtonsToRemove = config_bar_remove_buttons)

```

-->


# Taxi-Out Time

```{r Taxi-out-time-data-check, results='asis', eval=params$apdf != "Y"}

cat("<center> 
Analyses on taxi-out times are only available for airports providing the required data 
using the Airport Operator Data Flow (APDF).

If you belong to the airport and would like to implement such data flow, please contact DANSAP@eurocontrol.int </center>")
  
```

  
```{r Taxi-out-time-row1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r Taxi-out-time-title1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual Taxi-Out Time")

```


```{r TXOT YEARLY LAYOUT, results='asis', eval=params$apdf == "Y", echo = FALSE}

TXOT_YY <- params$txot_yy %>%
  tidyr::pivot_longer(
    cols      = c("AVG_UNIMP_TIME", "AVG_ADD_TIME"),
    names_to  = "TYPE",
    values_to = "TIME"
  )

TXOT_YY <- TXOT_YY %>%
  mutate(
    TYPE   = factor(TYPE,
                    levels = c("AVG_UNIMP_TIME", "AVG_ADD_TIME"),
                    labels = c("Avg. Reference time", "Avg. Additional time")
    ))

TXOT_YY <- TXOT_YY %>%
  mutate(YEAR = as.character(YEAR))


########################## KEY MESSAGE #########################################

TXOT_VAR <- params$txot_mm %>%
  filter(AVG_ADD_TIME != "NaN") %>%
  select(YEAR, TOT_FLT, TOT_ADD_TIME) %>%
  group_by(YEAR) %>%
  summarise(
    TOT_ADD_TIME = sum(TOT_ADD_TIME, na.rm = TRUE),
    TOT_FLT = sum(TOT_FLT, na.rm = TRUE)
  ) %>%
  ungroup()

CUM_TXOT <- params$txot_mm %>%
  filter(AVG_ADD_TIME != "NaN") %>%
  select(YEAR, MONTH_NUM, TOT_ADD_TIME, TOT_FLT) %>%
  mutate(across(c(YEAR, MONTH_NUM), as.numeric)) %>%
  filter(YEAR %in% c(max(YEAR), max(YEAR) - 1))

YEAR_MAX_MONTH <- CUM_TXOT %>%
  filter(YEAR == max(YEAR)) %>%
  pull(MONTH_NUM) %>%
  max() %>%
  unique()

CUM_TXOT <- CUM_TXOT %>%
  filter(MONTH_NUM <= YEAR_MAX_MONTH) %>%
  group_by(YEAR) %>%
  summarise(TOT_TXOT = sum(TOT_ADD_TIME, na.rm = TRUE) / sum(TOT_FLT, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(CHANGE = (TOT_TXOT - lag(TOT_TXOT)) / lag(TOT_TXOT))

msg_tmpl <- "<b>Add.Change Jan-{mnt}<br>{yr2} vs {yr1}:<br>{pct}% </b>"

msg <- str_glue(msg_tmpl,
                mnt = pick_mth[YEAR_MAX_MONTH],
                yr1 = CUM_TXOT$YEAR[1],
                yr2 = CUM_TXOT$YEAR[2],
                pct = round(100 * CUM_TXOT[2, "CHANGE"], 2)
)

# msg <- paste0("<b>Change Jan-",
#               pick_mth[YEAR_MAX_MONTH],
#               "<br>",
#               CUM_TXOT$YEAR[2],
#               " vs ",
#               CUM_TXOT$YEAR[1],
#               ":<br>",
#               round(100* CUM_TXOT[2,"CHANGE"], 2),"% </b>")

ALL_YEAR <- TXOT_YY %>%
  filter(TIME != "NaN") %>%
  pull(YEAR) %>%
  unique()

msg_y <- params$txot_yy %>%
  filter(AVG_ADD_TIME != "NaN") %>%
  filter(YEAR == as.integer(max(YEAR)) - 1) %>%
  mutate(TOT_TXOT = 1.1 * (AVG_UNIMP_TIME + AVG_ADD_TIME)) %>%
  pull(TOT_TXOT)

key_msg <- list(
  x         = length(ALL_YEAR) - 1,
  y         = msg_y,
  text      = msg,
  size      = 14,
  showarrow = FALSE
)

################################################################################


TXOT_YY %>%
  plotly::plot_ly(
    x          = ~YEAR,
    y          = ~TIME,
    type       = "bar",
    showlegend = TRUE,
    color      = ~TYPE
  ) %>%
  layout(
    barmode   = "stack",
    hovermode = "x unified",
    xaxis     = list(title = ""),
    yaxis     = list(
      title       = "Average Taxi-out time [min/dep]",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    ),
    annotations = key_msg
  ) %>%
  add_annotations(x         = 1, 
                  y         = -0.1, 
                  text      = "Source: APDF", 
                  showarrow = F, 
                  xref      = 'paper', 
                  yref      = 'paper', 
                  xanchor   = 'right', 
                  yanchor   = 'auto', 
                  xshift    = 0, 
                  yshift    = -10,
                  font      = list(size=12)
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```

  
```{r Taxi-out-time-title2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly Taxi-Out Time")

```


```{r TAXI-OUT MONTHLY LAYOUT, results='asis', eval=params$apdf == "Y", echo = FALSE}

TXOT_MM <- params$txot_mm %>%
  tidyr::pivot_longer(
    cols      = c("AVG_UNIMP_TIME", "AVG_ADD_TIME"),
    names_to  = "TYPE",
    values_to = "TIME"
  )

TXOT_MM <- TXOT_MM %>%
  mutate(TYPE = factor(
    TYPE,
    levels = c("AVG_UNIMP_TIME", "AVG_ADD_TIME"),
    labels = c("Avg. Reference time", "Avg. Additional time")
  ))

filter_years <- TXOT_MM %>%
  pull(YEAR) %>%
  unique()

max_year <- max(filter_years)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom",
  buttons   = button_list
)

TXOT_MM %>%
  plot_ly(
    x          = ~MONTH_NUM,
    y          = ~TIME,
    customdata = ~YEAR,
    color      = ~TYPE,
    type       = "bar",
    transforms = list(
      list(
        type      = "filter",
        target    = "customdata",
        operation = "=",
        value     = max_year
      ))
  ) %>%
  layout(
    barmode   = "stack",
    hovermode = "x unified",
    xaxis     = tick_yr_no_title,
    yaxis     = list(
      title       = "Average Taxi-out time [min/dep]",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    ),
    showlegend = TRUE,
    updatemenus = list(button_type_list),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: APDF",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -10,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```


```{r Taxi-out-time-row2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```



# Taxi-In Time

```{r Taxi-in-time-data-check, results='asis', eval=params$apdf != "Y"}

cat("
Analyses on taxi-in times are only available for airports providing the required data 
using the Airport Operator Data Flow (APDF).

If you belong to the airport and would like to implement such data flow, please contact DANSAP@eurocontrol.int")
  
```

  
```{r Taxi-in-time-row1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r Taxi-in-time-title1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual Taxi-In Time")

```


```{r TXIN YEARLY LAYOUT, results='asis', eval=params$apdf == "Y", echo = FALSE}

  TXIN_YY <- params$txin_yy %>%
    tidyr::pivot_longer(
      cols      = c("AVG_UNIMP_TIME", "AVG_ADD_TIME"),
      names_to  = "TYPE",
      values_to = "TIME"
    )

  TXIN_YY <- TXIN_YY %>%
    mutate(TYPE = factor(
      TYPE,
      levels = c("AVG_UNIMP_TIME", "AVG_ADD_TIME"),
      labels = c("Avg. Reference time", "Avg. Additional time")
    ))

  TXIN_YY <- TXIN_YY %>%
    mutate(YEAR = as.character(YEAR))



  ########################## KEY MESSAGE #########################################

  TXIN_VAR <- params$txin_mm %>%
    filter(AVG_ADD_TIME != "NaN") %>%
    select(YEAR, TOT_FLT, TOT_ADD_TIME) %>%
    group_by(YEAR) %>%
    summarise(
      TOT_ADD_TIME = sum(TOT_ADD_TIME, na.rm = TRUE),
      TOT_FLT = sum(TOT_FLT, na.rm = TRUE)
    ) %>%
    ungroup()

  CUM_TXIN <- params$txin_mm %>%
    filter(AVG_ADD_TIME != "NaN") %>%
    select(YEAR, MONTH_NUM, TOT_ADD_TIME, TOT_FLT) %>%
    mutate(across(c(YEAR, MONTH_NUM), as.numeric)) %>%
    filter(YEAR %in% c(max(YEAR), max(YEAR) - 1))

  YEAR_MAX_MONTH <- CUM_TXIN %>%
    filter(YEAR == max(YEAR)) %>%
    pull(MONTH_NUM) %>%
    max() %>%
    unique()

  CUM_TXIN <- CUM_TXIN %>%
    filter(MONTH_NUM <= YEAR_MAX_MONTH) %>%
    group_by(YEAR) %>%
    summarise(TOT_TXIN = sum(TOT_ADD_TIME, na.rm = TRUE) / sum(TOT_FLT, na.rm = TRUE)) %>%
    ungroup() %>%
    mutate(CHANGE = (TOT_TXIN - lag(TOT_TXIN)) / lag(TOT_TXIN))

  msg_tmpl <- "<b>Add.Change Jan-{mnt}<br>{yr2} vs {yr1}:<br>{pct}% </b>"

  msg <- str_glue(msg_tmpl,
    mnt = pick_mth[YEAR_MAX_MONTH],
    yr1 = CUM_TXIN$YEAR[1],
    yr2 = CUM_TXIN$YEAR[2],
    pct = round(100 * CUM_TXIN[2, "CHANGE"], 2)
  )

  # msg <- paste0("<b>Change Jan-",
  #               pick_mth[YEAR_MAX_MONTH],
  #               "<br>",
  #               CUM_TXIN$YEAR[2],
  #               " vs ",
  #               CUM_TXIN$YEAR[1],
  #               ":<br>",
  #               round(100* CUM_TXIN[2,"CHANGE"], 2),"% </b>")

  ALL_YEAR <- TXIN_YY %>%
    filter(TIME != "NaN") %>%
    pull(YEAR) %>%
    unique()

  msg_y <- params$txin_yy %>%
    filter(AVG_ADD_TIME != "NaN") %>%
    filter(YEAR == as.integer(max(YEAR)) - 1) %>%
    mutate(TOT_TXIN = 1.1 * (AVG_UNIMP_TIME + AVG_ADD_TIME)) %>%
    pull(TOT_TXIN)

  key_msg <- list(
    x = length(ALL_YEAR) - 1,
    y = msg_y,
    text = msg,
    size = 14,
    showarrow = FALSE
  )

  ################################################################################


  TXIN_YY %>%
    plotly::plot_ly(
      x          = ~YEAR,
      y          = ~TIME,
      type       = "bar",
      showlegend = TRUE,
      color      = ~TYPE
    ) %>%
    layout(
      barmode   = "stack",
      hovermode = "x unified",
      xaxis     = list(title = ""),
      yaxis     = list(
        title       = "Average Taxi-in time [min/arr]",
        titlefont   = list(size = 11),
        hoverformat = ".2f"
      ),
      annotations = key_msg
    ) %>%
    config(
      displaylogo = FALSE,
      modeBarButtonsToRemove = config_bar_remove_buttons
    )

```


```{r Taxi-in-time-title2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly Taxi-In Time")

```


```{r TAXI-IN MONTHLY LAYOUT, results='asis', eval=params$apdf == "Y", echo = FALSE}

  TXIN_MM <- params$txin_mm %>%
    tidyr::pivot_longer(
      cols      = c("AVG_UNIMP_TIME", "AVG_ADD_TIME"),
      names_to  = "TYPE",
      values_to = "TIME"
    )

  TXIN_MM <- TXIN_MM %>%
    mutate(TYPE = factor(TYPE,
      levels = c("AVG_UNIMP_TIME", "AVG_ADD_TIME"),
      labels = c("Avg. Reference time", "Avg. Additional time")
    ))

  filter_years <- TXIN_MM %>%
    pull(YEAR) %>%
    unique()

  max_year <- max(filter_years)

  button_list <- lapply(
    1:length(filter_years),
    function(x) {
      list(
        method = "restyle",
        args = list("transforms[0].value", filter_years[x]),
        label = filter_years[x]
      )
    }
  )

  button_type_list <- list(
    type      = "buttons",
    bgcolor   = "#c3c1e8",
    active    = length(filter_years) - 1,
    direction = "right",
    xref      = "paper",
    x         = 0.3,
    xanchor   = "left",
    yref      = "paper",
    y         = 1.2,
    yanchor   = "bottom",
    buttons   = button_list
  )

  TXIN_MM %>%
    plot_ly(
      x          = ~MONTH_NUM,
      y          = ~TIME,
      customdata = ~YEAR,
      color      = ~TYPE,
      type       = "bar",
      transforms = list(
        list(
          type      = "filter",
          target    = "customdata",
          operation = "=",
          value     = max_year
        )
      )
    ) %>%
    layout(
      barmode   = "stack",
      hovermode = "x unified",
      xaxis     = tick_yr_no_title,
      yaxis     = list(
        title       = "Average Taxi-in time [min/arr]",
        titlefont   = list(size = 11),
        hoverformat = ".2f"
      ),
      showlegend  = TRUE,
      updatemenus = list(button_type_list),
      ##############################################################################
      annotations = list(
        x         = 1,
        y         = -0.1,
        text      = "Source: APDF",
        showarrow = FALSE,
        xref      = "paper",
        yref      = "paper",
        xanchor   = "right",
        yanchor   = "auto",
        xshift    = 0,
        yshift    = -10,
        font      = list(size = 12)
      )
      ##############################################################################
    ) %>%
    config(
      displaylogo = FALSE,
      modeBarButtonsToRemove = config_bar_remove_buttons
    )

```


```{r Taxi-in-time-row2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```


# Pre-Dep Delay

```{r Pre-dep-delay-data-check, results='asis', eval=params$apdf != "Y"}

cat("
Analyses on pre-departure delay are only available for airports providing the required data 
using the Airport Operator Data Flow (APDF).

If you belong to the airport and would like to implement such data flow, please contact DANSAP@eurocontrol.int")
  
```

  
```{r Pre-dep-delay-row1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r Pre-dep-delay-title1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual Pre-Departure Delay")

```


```{r pre-dep-dly-pa, results='asis', eval=params$apdf == "Y", echo = FALSE}

PDDLY_YY <- params$pddly_yy %>%
  select(YEAR, TOT_DLY_89, TOT_DLY_OTHER, TOT_DLY_UNID) %>%
  tidyr::pivot_longer(
    cols      = starts_with("TOT_DLY_"),
    names_to  = "DLY_CAT",
    values_to = "DLY_DUR"
  )

predep_col <- c(
  "#F8CBAD", # RGB 248,203,173 # Unidentified
  "#BDD7EE", # RGB 189,215,238 # Other reasons
  "#4682B4"
) # RGB 198,224,180 # ATC Pre-Departure delay (code 89)

PDDLY_YY$DLY_CAT <- factor(PDDLY_YY$DLY_CAT,
                           levels = c("TOT_DLY_UNID", "TOT_DLY_OTHER", "TOT_DLY_89"),
                           labels = c("Unidentified", "Other reasons", "ATC Pre-Departure <br>delay (code 89)")
)


PDDLY_YY <- PDDLY_YY %>%
  mutate(YEAR = as.character(YEAR))

PDDLY_YY %>%
  plot_ly(
    x             = ~YEAR,
    y             = ~DLY_DUR,
    type          = "bar",
    color         = ~DLY_CAT,
    colors        = predep_col,
    # legendgroup = ~DLY_CAT,
    hovertemplate = "%{y:.r}"
  ) %>%
  layout(
    barmode   = "stack",
    hovermode = "x unified",
    xaxis     = list(title = ""),
    yaxis     = list(
      title     = "Pre-Departure delay [min]",
      titlefont = list(size = 11)
    ),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: APDF",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -5,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```


```{r Pre-dep-delay-title2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly Pre-Departure Delay")

```


```{r pre-dep-dly-month, results='asis', eval=params$apdf == "Y", echo = FALSE}

PDDLY_MM <- params$pddly_mm %>%
  select(
    YEAR,
    MONTH_NUM,
    TOT_DLY_89,
    TOT_DLY_OTHER,
    TOT_DLY_UNID
  ) %>%
  tidyr::pivot_longer(
    cols      = starts_with("TOT_DLY_"),
    names_to  = "DLY_CAT",
    values_to = "DLY_DUR"
  )


PDDLY_MM$DLY_CAT <- factor(
  PDDLY_MM$DLY_CAT,
  levels = c("TOT_DLY_UNID", "TOT_DLY_OTHER", "TOT_DLY_89"),
  labels = c("Unidentified", "Other reasons", "ATC Pre-Departure <br> delay (code 89)")
)

filter_years <- PDDLY_MM %>%
  pull(YEAR) %>%
  unique()

max_year <- max(filter_years)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)

PDDLY_MM %>%
  plot_ly(
    x             = ~MONTH_NUM,
    y             = ~DLY_DUR,
    type          = "bar",
    color         = ~DLY_CAT,
    colors        = predep_col,
    # legendgroup = ~DLY_CAT,
    hovertemplate = "%{y:.r}",
    customdata    = ~YEAR,
    transforms    = list(
      list(
        type        = "filter",
        target      = "customdata",
        operation   = "=",
        value       = max_year
      )
    )
  ) %>%
  layout(
    barmode     = "stack",
    xaxis       = tick_yr_no_title,
    yaxis       = list(
      title     = "Pre-Departure delay [min]",
      titlefont = list(size = 11)
    ),
    showlegend = TRUE,
    updatemenus = list(button_type_list),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: APDF",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -10,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```

```{r Pre-dep-delay-row2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```


<!-- 

### Monthly Pre-Departure Delay Trend

```{r, results='asis', eval=params$apdf == "Y", echo = FALSE}


TMP <- PDDLY_MM %>%
mutate( DATE_YM = paste0(YEAR,"-",MONTH_NUM),
DATE_YM = lubridate::parse_date_time(DATE_YM, "ym") )

TMP %>%
plot_ly() %>%
add_bars(x     = ~DATE_YM, 
y     = ~DLY_DUR, 
color = ~DLY_CAT,
hovertemplate = "%{y:.r}") %>%
layout(barmode = "stack",
xaxis = list(title = "",
rangeselector = list(buttons = list(list(count    = 3,
label    = "3 mo",
step     = "month",
stepmode = "backward"),
list(count    = 6,
label    = "6 mo",
step     = "month",
stepmode = "backward"),
list(count    = 1,
label    = "1 yr",
step     = "year",
stepmode = "backward"),
list(count    = 1,
label    = "YTD",
step     = "year",
stepmode = "todate"),
list(step     = "all"))),
rangeslider = list(type = "date")
), 
yaxis = list( title = "Pre-Departure delay [min]",
titlefont = list(size = 11))) %>% 
config( displaylogo = FALSE,
modeBarButtonsToRemove = config_bar_remove_buttons)


```

-->

```{r Pre-dep-delay-title3, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual Average ATC Pre-Departure Delay")

```


```{r pre-dep-dly-year-atc, results='asis', eval=params$apdf == "Y", echo = FALSE}

params$pddly_yy_avg %>%
  plot_ly(
    x     = ~YEAR,
    y     = ~AVG_PREDEP_DLY,
    type  = "bar",
    color = I("steelblue")
  ) %>%
  layout(
    xaxis = list(title = ""),
    yaxis = list(
      title       = "Avg. ATC Pre-Departure delay [min/dep]",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    ),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: APDF",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -5,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```


```{r Pre-dep-delay-title4, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly Average ATC Pre-Departure Delay")

```


```{r pre-dep-indicator, results='asis', eval=params$apdf == "Y", echo = FALSE}

predepdly_pm <- params$pddly_avg %>%
  select(YEAR, MONTH_NUM, AVG_PREDEP_DLY)

filter_years <- predepdly_pm %>%
  pull(YEAR) %>%
  unique()

max_year <- max(filter_years)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)


predepdly_pm %>%
  plot_ly(
    x          = ~MONTH_NUM,
    y          = ~AVG_PREDEP_DLY,
    customdata = ~YEAR,
    color      = I("steelblue"),
    type       = "bar",
    transforms = list(
      list(
        type      = "filter",
        target    = "customdata",
        operation = "=",
        value     = max_year
      )
    )
  ) %>%
  layout(
    barmode = "stack",
    xaxis   = tick_yr_no_title,
    yaxis   = list(
      title       = "Avg. ATC Pre-Departure delay [min/dep]",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    ),
    showlegend  = FALSE,
    updatemenus = list(button_type_list),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: APDF",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -10,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```



# Turnaround Times


```{r Turnaround-times-data-check, results='asis', eval=params$apdf != "Y"}

cat("
Analyses on turnaround times are only available for airports providing the required data 
using the Airport Operator Data Flow (APDF).

If you belong to the airport and would like to implement such data flow, please contact DANSAP@eurocontrol.int")
  
```

  
```{r Turnaround-times-row1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r Turnaround-times-title1, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Annual Actual Turnaround Time")

```


```{r annual_turn_time, results='asis', eval=params$apdf == "Y", echo = FALSE}

TURN_YY <- params$turn_yy %>%
  select(YEAR, AC_CLASS, AVG_ACTT)

turn_col <- c(
  "#C6E0B4", # RGB 198,224,180 # Heavy
  "#F8CBAD", # RGB 248,203,173 # Medium Jet
  "#BDD7EE"
) # RGB 189,215,238 # Medium Turboprop

TURN_YY$AC_CLASS <- factor(TURN_YY$AC_CLASS,
                           levels = c("H", "MJ", "MT"),
                           labels = c("Heavy", "Medium Jet", "Medium Turboprop")
)

TURN_YY <- TURN_YY %>%
  mutate(YEAR = as.character(YEAR))


TURN_YY %>%
  plot_ly(
    x      = ~YEAR,
    y      = ~AVG_ACTT,
    type   = "bar",
    color  = ~AC_CLASS,
    colors = turn_col
  ) %>%
  layout(
    barmode   = "group",
    hovermode = "x unified",
    xaxis     = list(title = ""),
    yaxis     = list(
      title       = "Average Actual Turnaround time [min/flight]",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    ),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: APDF",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -5,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```


```{r Turnaround-times-title2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Monthly Turnaround Times")

```


```{r monthly_turn_time, results='asis', eval=params$apdf == "Y", echo = FALSE}

TURN_MM <- params$turn_mm %>%
  select(YEAR, MONTH_NUM, TOT_TURN, AC_CLASS, AVG_ACTT, AVG_SDTT) %>%
  mutate(
    LBL_ACTUAL = paste0("Actual Turnaround ", AC_CLASS),
    LBL_SCHED = paste0("Scheduled Turnaround ", AC_CLASS),
    HOVERTEXTACTT = paste0(
      "Class: ", AC_CLASS,
      "<br>Avg. Turn:", round(AVG_ACTT, 2), "min",
      "<br>Nb Turn. :", TOT_TURN
    ),
    HOVERTEXTSDTT = paste0(
      "Class: ", AC_CLASS,
      "<br>Avg. Turn:", round(AVG_SDTT, 2), "min",
      "<br>Nb Turn. :", TOT_TURN
    )
  )

filter_years <- TURN_MM %>%
  pull(YEAR) %>%
  unique()

max_year <- max(filter_years)

button_list <- lapply(
  1:length(filter_years),
  function(x) {
    list(
      method = "restyle",
      args = list("transforms[0].value", filter_years[x]),
      label = filter_years[x]
    )
  }
)

button_type_list <- list(
  buttons   = button_list,
  type      = "buttons",
  bgcolor   = "#c3c1e8",
  active    = length(filter_years) - 1,
  direction = "right",
  xref      = "paper",
  x         = 0.3,
  xanchor   = "left",
  yref      = "paper",
  y         = 1.2,
  yanchor   = "bottom"
)


TURN_MM %>%
  plot_ly() %>%
  add_lines(
    x          = ~MONTH_NUM,
    y          = ~AVG_ACTT,
    color      = ~AC_CLASS,
    colors     = turn_col,
    name       = ~LBL_ACTUAL,
    customdata = ~YEAR,
    transforms = list(
      list(
        type      = "filter",
        target    = "customdata",
        operation = "=",
        value     = max_year
      )
    ),
    text          = ~HOVERTEXTACTT,
    hovertemplate = paste0("%{text}"),
    legendgroup   = ~AC_CLASS,
    showlegend    = TRUE
  ) %>%
  add_lines(
    x          = ~MONTH_NUM,
    y          = ~AVG_SDTT,
    color      = ~AC_CLASS,
    colors     = turn_col,
    name       = ~LBL_SCHED,
    line       = list(dash = "dash"),
    customdata = ~YEAR,
    transforms = list(
      list(
        type      = "filter",
        target    = "customdata",
        operation = "=",
        value     = max_year
      )
    ),
    text          = ~HOVERTEXTSDTT,
    hovertemplate = paste0("%{text}"),
    legendgroup = ~AC_CLASS,
    showlegend = TRUE
  ) %>%
  layout(
    updatemenus = list(button_type_list),
    hovermode   = "x unified",
    xaxis       = tick_yr_no_title,
    yaxis       = list(
      title     = "Average Turnaround times [min/flight]",
      titlefont = list(size = 11)
    ),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: APDF",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -10,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```


```{r Turnaround-times-row2, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("## Row -----------------------------------------------------------")

```

  
```{r Turnaround-times-title3, results='asis', eval=params$apdf == "Y", echo = FALSE}

cat("### Variation of Annual Actual Turnaround Times")

```


```{r annual-turn-time-var, results='asis', eval=params$apdf == "Y", echo = FALSE}

TURN_MM <- TURN_MM %>%
  mutate(AC_CLASS = factor(
    AC_CLASS,
    levels = c("H", "MJ", "MT"),
    labels = c("Heavy", "Medium Jet", "Medium Turboprop")
  ))

TURN_MM %>%
  plot_ly(
    x      = ~YEAR,
    y      = ~AVG_ACTT,
    color  = ~AC_CLASS,
    colors = turn_col,
    type   = "box"
  ) %>%
  layout(
    boxmode = "group",
    xaxis   = list(title = ""),
    yaxis   = list(
      title       = "Average Actual Turnaround time [min/flight]",
      titlefont   = list(size = 11),
      hoverformat = ".2f"
    ),
    ##############################################################################
    annotations = list(
      x         = 1,
      y         = -0.1,
      text      = "Source: APDF",
      showarrow = FALSE,
      xref      = "paper",
      yref      = "paper",
      xanchor   = "right",
      yanchor   = "auto",
      xshift    = 0,
      yshift    = -5,
      font      = list(size = 12)
    )
    ##############################################################################
  ) %>%
  config(
    displaylogo = FALSE,
    modeBarButtonsToRemove = config_bar_remove_buttons
  )

```

# About

## Row ------------------------------------------------------------------

### Powered by

![](https://ansperformance.eu/images/eurocontrol-logo.png){width=30%}


### About this Dashboard

This data is published by the EUROCONTROL Performance Review Unit (PRU) in the interest of the exchange of information. 
It may be copied in whole or in part providing that this copyright notice © and disclaimer are included. 
The information may not be modified without prior written permission from the EUROCONTROL Performance Review Unit.
The information does not necessarily reflect the official views or policy of EUROCONTROL, which makes no warranty, either implied or expressed, for the information contained in this document, including its accuracy, completeness or usefulness.
Every effort has been made to ensure that the information and analysis contained on this website are as accurate and complete as possible. Despite these precautions, should you find any errors or inconsistencies or if you have any questions then please contact us at: Performance Review Unit (PRU-Support@eurocontrol.int).

### About Performance Review Unit

The PRU is responsible for monitoring and reviewing the performance of the Pan-European ANS system across a number of key performance areas.
As part of the EUROCONTROL Agency, the PRU supports the independent Performance Review Commission (PRC) in running the EUROCONTROL Performance Review System and executing the associated PRC work programme with the appropriate level of independence.
The PRU also provides support to the European Commission (EC) on the SES Performance and Charging Schemes.
In performing its tasks, the PRU maintains transparent working arrangements with service providers, airspace user organisations and the industry.
Although the PRU is independent, it is administratively reporting to the Directorate European Civil-Military Aviation (DECMA).
For feedback or questions please contact us at: Performance Review Unit (PRU-Support@eurocontrol.int).

## Row ------------------------------------------------------------------

### Data and Methodology

This dashboard is updated on a monthly basis.  

IFR traffic data and ATFM delay related data is extracted from the Network Manager.
CDO/CCO data are calculated by the Aviation Intelligence Unit of EUROCONTROL based on Network Manager data.
All other airport related data is collected through the Airport Operator Data Flow (APDF). Under the APDF airports are required to report flight-by-flight data on a monthly basis. The data is reported during the month following the month of operations. Thus, typically, APDF data becomes available the 2nd month following the month of operation.

**Data and metrics are shown based on availability at the moment of publication**    

* Traffic data comprises all IFR flown flight plans for the airport (arrivals and departures) based on NM data.
*	ATFM delay data captures the arrival ATFM delay triggered by constraints at the airport based on NM data.
*	ATFM delays are grouped according to the regulation reason as described in https://ansperformance.eu/definition/atfm-delay-codes/
* CDO/CCO performance is calculated by identifying level segments during the climb and descent. These level segments are considered to be inefficient. For more information please visit https://ansperformance.eu/efficiency/vfe/
*	Additional ASMA time measures the difference between an observed travel time elapsing from entering the 40NM radius around the airport to landing. This time is compared against a reference time to the respective entry sector, aircraft type, and landing runway.
For more information please visit https://ansperformance.eu/methodology/additional-asma-time-pi/
*	In analogy, additional taxi-times are measured for the taxi-out and taxi-in phase. The observed taxi times are compared with a respective reference time. The reference time considers the parking position and runway used by the departure/arrival.
For more information please visit https://ansperformance.eu/definition/additional-taxi-out-time/
*	Pre-departure delay is the delay in the off-block time with respect to the schedule time for departure. It provides for the airspace user reported delay reasoning in case of departures blocking off late. Delay codes have to be provided for delays >= 4 minutes. Most airports per se do not validate these delay codes, however, effort is underway to ensure appropriateness of the reported delay codes.Delay reasons are reported according to the IATA delay codes https://ansperformance.eu/library/iata-delay-codes.pdf 
Delay reported associated to code 89 is used for the calculation of the ATC pre-departure delay https://ansperformance.eu/definition/atc-pre-departure-delay/ 
*	Turnaround shows the time elapsing between an aircraft blocking in and blocking off for the next flight from the same parking stand on the same day and the sample is treated to filter out.